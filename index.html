<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>日本旅遊規劃 - Japan Trip Planner</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        base: { DEFAULT: '#FAF9F6', secondary: '#F5F5F5' },
                        primary: { DEFAULT: '#8B7355', light: '#A68968', dark: '#6D5C44' },
                        accent: { DEFAULT: '#D3D3D3', warm: '#E8E4C6', pink: '#FFE4E1' },
                        category: {
                            food: '#FF8C42',
                            sightseeing: '#4A90E2',
                            transport: '#50C878',
                            hotel: '#9B59B6',
                            shopping: '#FF69B4',
                            other: '#95A5A6',
                        }
                    },
                    fontFamily: { sans: ['Inter', 'Noto Sans JP', 'sans-serif'] },
                }
            }
        }
    </script>
    
    <style>
        body { font-family: 'Inter', 'Noto Sans JP', sans-serif; background-color: #FAF9F6; }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); }
        .card-shadow { box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05); }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .page { display: none; }
        .page.active { display: block; }
        .nav-item.active { background-color: #8B7355; color: white; }
        .modal { display: none; }
        .modal.active { display: flex; }
        .sortable-ghost { opacity: 0.4; background: #fef3c7 !important; }
        .sortable-chosen { background-color: #fef3c7 !important; }
        .drag-handle { cursor: grab; }
        .drag-handle:active { cursor: grabbing; }
        input[type="range"] { -webkit-appearance: none; width: 100%; height: 6px; background: #e5e7eb; border-radius: 3px; }
        input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; width: 18px; height: 18px; background: #8B7355; border-radius: 50%; cursor: pointer; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .animate-spin { animation: spin 1s linear infinite; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .toast { animation: fadeIn 0.3s ease-out; }
    </style>
</head>
<body class="antialiased">
    <div class="flex h-screen overflow-hidden">
        <!-- 側邊欄 -->
        <aside class="hidden lg:flex w-64 h-screen bg-white border-r border-gray-200 flex-col flex-shrink-0">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-primary rounded-xl flex items-center justify-center">
                        <i data-lucide="plane" class="w-5 h-5 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-semibold text-gray-800">日本旅遊</h1>
                        <p class="text-xs text-gray-500">Trip Planner</p>
                    </div>
                </div>
            </div>
            
            <nav class="flex-1 p-4 space-y-2">
                <button onclick="showPage('dashboard')" class="nav-item active w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all text-left" data-page="dashboard">
                    <i data-lucide="home" class="w-5 h-5"></i>
                    <span class="font-medium">首頁</span>
                </button>
                <button onclick="showPage('trip')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all text-gray-600 hover:bg-gray-50 text-left" data-page="trip">
                    <i data-lucide="calendar" class="w-5 h-5"></i>
                    <span class="font-medium">行程規劃</span>
                </button>
                <button onclick="showPage('budget')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all text-gray-600 hover:bg-gray-50 text-left" data-page="budget">
                    <i data-lucide="wallet" class="w-5 h-5"></i>
                    <span class="font-medium">預算追蹤</span>
                </button>
                <button onclick="showPage('toolbox')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all text-gray-600 hover:bg-gray-50 text-left" data-page="toolbox">
                    <i data-lucide="wrench" class="w-5 h-5"></i>
                    <span class="font-medium">旅行工具</span>
                </button>
            </nav>
            
            <div class="p-4">
                <div class="bg-gradient-to-br from-accent-pink to-accent-warm rounded-2xl p-4">
                    <p class="text-sm font-medium text-gray-700 mb-1">✨ 開始規劃您的旅程</p>
                    <p class="text-xs text-gray-600">探索日本，創造美好回憶</p>
                </div>
            </div>
        </aside>
        
        <!-- 主內容區 -->
        <main class="flex-1 overflow-y-auto">
            <!-- 移動版頭部 -->
            <header class="lg:hidden glass border-b border-gray-200 sticky top-0 z-40">
                <div class="flex items-center justify-between p-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center">
                            <i data-lucide="plane" class="w-4 h-4 text-white"></i>
                        </div>
                        <span class="font-semibold text-gray-800">日本旅遊</span>
                    </div>
                    <button onclick="toggleMobileMenu()" class="p-2 hover:bg-gray-100 rounded-lg">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>
                </div>
            </header>
            
            <!-- 移動版選單 -->
            <div id="mobileMenu" class="fixed inset-0 z-50 hidden">
                <div class="absolute inset-0 bg-black/20 backdrop-blur-sm" onclick="toggleMobileMenu()"></div>
                <div class="absolute top-0 right-0 bottom-0 w-64 bg-white shadow-2xl p-6">
                    <button onclick="toggleMobileMenu()" class="absolute top-4 right-4 p-2 hover:bg-gray-100 rounded-lg">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                    <nav class="space-y-2 mt-16">
                        <button onclick="showPage('dashboard'); toggleMobileMenu();" class="mobile-nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl text-left bg-primary text-white" data-page="dashboard">
                            <i data-lucide="home" class="w-5 h-5"></i><span class="font-medium">首頁</span>
                        </button>
                        <button onclick="showPage('trip'); toggleMobileMenu();" class="mobile-nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl text-left text-gray-600 hover:bg-gray-50" data-page="trip">
                            <i data-lucide="calendar" class="w-5 h-5"></i><span class="font-medium">行程規劃</span>
                        </button>
                        <button onclick="showPage('budget'); toggleMobileMenu();" class="mobile-nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl text-left text-gray-600 hover:bg-gray-50" data-page="budget">
                            <i data-lucide="wallet" class="w-5 h-5"></i><span class="font-medium">預算追蹤</span>
                        </button>
                        <button onclick="showPage('toolbox'); toggleMobileMenu();" class="mobile-nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl text-left text-gray-600 hover:bg-gray-50" data-page="toolbox">
                            <i data-lucide="wrench" class="w-5 h-5"></i><span class="font-medium">旅行工具</span>
                        </button>
                    </nav>
                </div>
            </div>
            
            <div class="p-4 lg:p-8">
                <!-- Dashboard 頁面 -->
                <div id="page-dashboard" class="page active max-w-7xl mx-auto">
                    <div class="mb-8">
                        <h1 class="text-3xl lg:text-4xl font-bold text-gray-800 mb-2">我的旅程</h1>
                        <p class="text-gray-500">開始規劃你的下一趟日本旅行</p>
                    </div>
                    <div id="tripGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </div>
                
                <!-- Trip 頁面 -->
                <div id="page-trip" class="page max-w-7xl mx-auto">
                    <button onclick="showPage('dashboard')" class="flex items-center space-x-2 text-gray-600 hover:text-gray-800 mb-6">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i><span>返回首頁</span>
                    </button>
                    
                    <div id="tripDetailHeader" class="mb-8"></div>
                    
                    <div id="tripNotSelected" class="text-center py-20 text-gray-500">
                        <i data-lucide="calendar" class="w-16 h-16 mx-auto mb-4 text-gray-400"></i>
                        <p>請先從首頁選擇一個旅程</p>
                    </div>
                    
                    <div id="tripContent" class="hidden grid grid-cols-1 lg:grid-cols-4 gap-6">
                        <div class="lg:col-span-1">
                            <div id="daySelector" class="space-y-3"></div>
                        </div>
                        
                        <div class="lg:col-span-3">
                            <div class="bg-white rounded-2xl p-6 card-shadow">
                                <div class="flex items-center justify-between mb-6">
                                    <h2 id="currentDayTitle" class="text-xl font-semibold text-gray-800">第 1 天行程</h2>
                                    <button onclick="openModal('addActivityModal')" class="flex items-center space-x-2 px-4 py-2 bg-primary text-white rounded-xl hover:bg-primary-dark transition-colors">
                                        <i data-lucide="plus" class="w-5 h-5"></i><span>新增活動</span>
                                    </button>
                                </div>
                                
                                <div id="weatherInfo" class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 mb-6 flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center">
                                            <i data-lucide="sun" class="w-6 h-6 text-yellow-500"></i>
                                        </div>
                                        <div>
                                            <div class="text-sm text-gray-600">今日天氣</div>
                                            <div id="weatherCondition" class="font-semibold text-gray-800">晴天</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div id="weatherMaxTemp" class="text-2xl font-bold text-gray-800">20°</div>
                                        <div id="weatherMinTemp" class="text-sm text-gray-600">最低 10°</div>
                                    </div>
                                </div>
                                
                                <div class="mb-4 p-3 bg-amber-50 border border-amber-200 rounded-xl flex items-center space-x-2 text-sm text-amber-700">
                                    <i data-lucide="info" class="w-4 h-4 flex-shrink-0"></i>
                                    <span>提示：拖動 ⋮⋮ 圖標可調整活動順序</span>
                                </div>
                                
                                <div id="activityList" class="space-y-4"></div>
                                
                                <div id="noActivities" class="text-center py-20 text-gray-500">
                                    <p>尚未新增任何活動</p>
                                    <p class="text-sm mt-2">點擊「新增活動」開始規劃</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Budget 頁面 -->
                <div id="page-budget" class="page max-w-7xl mx-auto">
                    <div class="mb-8">
                        <h1 class="text-3xl lg:text-4xl font-bold text-gray-800 mb-2">預算追蹤</h1>
                        <p class="text-gray-500">掌握您的旅行支出</p>
                    </div>
                    
                    <div class="mb-6">
                        <select id="budgetTripSelect" onchange="updateBudgetDisplay()" class="px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 bg-white"></select>
                    </div>
                    
                    <div id="budgetNoTrips" class="text-center py-20 text-gray-500">
                        <i data-lucide="wallet" class="w-16 h-16 mx-auto mb-4 text-gray-400"></i>
                        <p>尚未建立任何旅程</p>
                    </div>
                    
                    <div id="budgetContent" class="hidden">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="bg-white rounded-2xl p-6 card-shadow">
                                <div class="flex items-center justify-between mb-4">
                                    <span class="text-gray-500">總預算</span>
                                    <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
                                        <i data-lucide="wallet" class="w-5 h-5 text-blue-600"></i>
                                    </div>
                                </div>
                                <div id="totalBudget" class="text-3xl font-bold text-gray-800">¥200,000</div>
                            </div>
                            
                            <div class="bg-white rounded-2xl p-6 card-shadow">
                                <div class="flex items-center justify-between mb-4">
                                    <span class="text-gray-500">已花費</span>
                                    <div class="w-10 h-10 bg-orange-100 rounded-xl flex items-center justify-center">
                                        <i data-lucide="trending-up" class="w-5 h-5 text-orange-600"></i>
                                    </div>
                                </div>
                                <div id="totalSpent" class="text-3xl font-bold text-gray-800">¥0</div>
                                <div id="spentPercentage" class="text-sm text-gray-500 mt-1">0% 已使用</div>
                            </div>
                            
                            <div id="remainingCard" class="bg-white rounded-2xl p-6 card-shadow">
                                <div class="flex items-center justify-between mb-4">
                                    <span id="remainingLabel" class="text-gray-500">剩餘預算</span>
                                    <div class="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center">
                                        <i data-lucide="trending-down" class="w-5 h-5 text-green-600"></i>
                                    </div>
                                </div>
                                <div id="remainingBudget" class="text-3xl font-bold text-gray-800">¥200,000</div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white rounded-2xl p-6 card-shadow">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">支出分佈</h3>
                                <div class="h-[300px] flex items-center justify-center">
                                    <canvas id="budgetPieChart"></canvas>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-2xl p-6 card-shadow">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">支出類別</h3>
                                <div id="categoryList" class="space-y-4"></div>
                            </div>
                        </div>
                        
                        <div class="bg-white rounded-2xl p-6 card-shadow mt-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">預算設定</h3>
                            <div class="flex items-end space-x-4">
                                <div class="flex-1">
                                    <label class="block text-sm text-gray-600 mb-2">總預算 (¥)</label>
                                    <input type="number" id="budgetInput" class="w-full px-4 py-3 border border-gray-300 rounded-xl" min="0" step="10000" value="200000">
                                </div>
                                <button onclick="saveBudget()" class="px-6 py-3 bg-primary text-white rounded-xl font-medium hover:bg-primary-dark">儲存</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Toolbox 頁面 -->
                <div id="page-toolbox" class="page max-w-7xl mx-auto">
                    <div class="mb-8">
                        <h1 class="text-3xl lg:text-4xl font-bold text-gray-800 mb-2">旅行工具箱</h1>
                        <p class="text-gray-500">實用工具，讓旅程更順暢</p>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- 檢查清單 -->
                        <div class="bg-white rounded-2xl p-6 card-shadow">
                            <div class="flex items-center space-x-3 mb-4">
                                <div class="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="check-circle-2" class="w-5 h-5 text-green-600"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-800">出發前檢查清單</h3>
                            </div>
                            <div class="mb-4">
                                <div class="flex justify-between text-sm text-gray-600 mb-2">
                                    <span>完成進度</span>
                                    <span id="checklistProgress">0/10</span>
                                </div>
                                <div class="h-2 bg-gray-100 rounded-full overflow-hidden">
                                    <div id="checklistProgressBar" class="h-full bg-green-500 rounded-full transition-all" style="width: 0%"></div>
                                </div>
                            </div>
                            <div id="checklistItems" class="space-y-2 max-h-[280px] overflow-y-auto scrollbar-hide mb-4"></div>
                            <div class="flex space-x-2">
                                <input type="text" id="newChecklistItem" placeholder="新增項目..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm" onkeypress="if(event.key==='Enter')addChecklistItem()">
                                <button onclick="addChecklistItem()" class="px-3 py-2 bg-primary text-white rounded-lg">
                                    <i data-lucide="plus" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- 貨幣轉換器 -->
                        <div class="bg-white rounded-2xl p-6 card-shadow">
                            <div class="flex items-center space-x-3 mb-4">
                                <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="arrow-left-right" class="w-5 h-5 text-blue-600"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-800">貨幣轉換器</h3>
                            </div>
                            <div class="mb-4 p-3 bg-gray-50 rounded-xl">
                                <div class="flex items-center justify-between flex-wrap gap-2">
                                    <span class="text-sm text-gray-600">當前匯率</span>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-sm">1 JPY =</span>
                                        <input type="number" id="exchangeRate" value="0.051" step="0.001" class="w-20 px-2 py-1 border rounded text-sm" onchange="convertJpyToHkd()">
                                        <span class="text-sm">HKD</span>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm text-gray-600 mb-2">計算機（支援算式）</label>
                                <div class="flex space-x-2">
                                    <input type="text" id="currencyExpression" placeholder="如：500+200*3" class="flex-1 px-4 py-3 border rounded-xl" onkeypress="if(event.key==='Enter')calculateCurrencyExpression()">
                                    <button onclick="calculateCurrencyExpression()" class="px-4 py-3 bg-primary text-white rounded-xl">=</button>
                                </div>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm text-gray-600 mb-2">日圓 (JPY)</label>
                                    <div class="relative">
                                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500">¥</span>
                                        <input type="number" id="jpyAmount" placeholder="0" class="w-full pl-10 pr-4 py-3 border rounded-xl text-lg" oninput="convertJpyToHkd()">
                                    </div>
                                </div>
                                <div class="flex justify-center">
                                    <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
                                        <i data-lucide="arrow-down-up" class="w-5 h-5 text-gray-500"></i>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600 mb-2">港幣 (HKD)</label>
                                    <div class="relative">
                                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500">$</span>
                                        <input type="number" id="hkdAmount" placeholder="0" class="w-full pl-10 pr-4 py-3 border rounded-xl text-lg" oninput="convertHkdToJpy()">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 語言翻譯器 -->
                        <div class="bg-white rounded-2xl p-6 card-shadow">
                            <div class="flex items-center space-x-3 mb-4">
                                <div class="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="languages" class="w-5 h-5 text-purple-600"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-800">語言翻譯器</h3>
                            </div>
                            <div class="flex items-center space-x-2 mb-4">
                                <select id="sourceLang" class="flex-1 px-3 py-2 border rounded-lg text-sm">
                                    <option value="ja">日文</option>
                                    <option value="en">英文</option>
                                    <option value="ko">韓文</option>
                                </select>
                                <i data-lucide="arrow-right" class="w-4 h-4 text-gray-400"></i>
                                <select id="targetLang" class="flex-1 px-3 py-2 border rounded-lg text-sm">
                                    <option value="zh-TW">繁體中文</option>
                                    <option value="en">英文</option>
                                    <option value="ja">日文</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <textarea id="sourceText" placeholder="輸入要翻譯的文字..." rows="3" class="w-full px-4 py-3 border rounded-xl resize-none"></textarea>
                            </div>
                            <button onclick="translateText()" id="translateBtn" class="w-full px-4 py-3 bg-primary text-white rounded-xl font-medium mb-4 flex items-center justify-center space-x-2">
                                <span id="translateBtnText">翻譯</span>
                                <div id="translateSpinner" class="hidden animate-spin w-5 h-5 border-2 border-white border-t-transparent rounded-full"></div>
                            </button>
                            <div class="mb-4">
                                <div class="text-xs text-gray-500 mb-2">常用短語</div>
                                <div class="flex flex-wrap gap-1">
                                    <button onclick="quickTranslate('こんにちは')" class="px-2 py-1 bg-gray-100 rounded-full text-xs hover:bg-gray-200">こんにちは</button>
                                    <button onclick="quickTranslate('ありがとう')" class="px-2 py-1 bg-gray-100 rounded-full text-xs hover:bg-gray-200">ありがとう</button>
                                    <button onclick="quickTranslate('すみません')" class="px-2 py-1 bg-gray-100 rounded-full text-xs hover:bg-gray-200">すみません</button>
                                    <button onclick="quickTranslate('いくらですか')" class="px-2 py-1 bg-gray-100 rounded-full text-xs hover:bg-gray-200">いくらですか</button>
                                    <button onclick="quickTranslate('トイレはどこですか')" class="px-2 py-1 bg-gray-100 rounded-full text-xs hover:bg-gray-200">トイレ</button>
                                    <button onclick="quickTranslate('美味しい')" class="px-2 py-1 bg-gray-100 rounded-full text-xs hover:bg-gray-200">美味しい</button>
                                    <button onclick="quickTranslate('お会計お願いします')" class="px-2 py-1 bg-gray-100 rounded-full text-xs hover:bg-gray-200">お会計</button>
                                    <button onclick="quickTranslate('駅はどこですか')" class="px-2 py-1 bg-gray-100 rounded-full text-xs hover:bg-gray-200">駅</button>
                                </div>
                            </div>
                            <div id="translationResult" class="hidden p-4 bg-purple-50 rounded-xl">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm text-purple-600">翻譯結果</span>
                                    <button onclick="copyTranslation()" class="text-xs text-purple-600 hover:text-purple-800 flex items-center space-x-1">
                                        <i data-lucide="copy" class="w-3 h-3"></i><span>複製</span>
                                    </button>
                                </div>
                                <div id="translatedText" class="text-gray-800"></div>
                            </div>
                        </div>
                        
                        <!-- 折扣計算機 -->
                        <div class="bg-white rounded-2xl p-6 card-shadow">
                            <div class="flex items-center space-x-3 mb-4">
                                <div class="w-10 h-10 bg-pink-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="percent" class="w-5 h-5 text-pink-600"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-800">折扣計算機</h3>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm text-gray-600 mb-2">計算機</label>
                                <div class="flex space-x-2">
                                    <input type="text" id="discountExpression" placeholder="如：1000+500" class="flex-1 px-4 py-3 border rounded-xl" onkeypress="if(event.key==='Enter')calculateDiscountExpression()">
                                    <button onclick="calculateDiscountExpression()" class="px-4 py-3 bg-primary text-white rounded-xl">=</button>
                                </div>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm text-gray-600 mb-2">原價 (¥)</label>
                                <div class="relative">
                                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500">¥</span>
                                    <input type="number" id="originalPrice" placeholder="0" class="w-full pl-10 pr-4 py-3 border rounded-xl text-lg" oninput="calculateDiscount()">
                                </div>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm text-gray-600 mb-2">折扣（70 = 7折）</label>
                                <div class="flex items-center space-x-4">
                                    <input type="range" id="discountSlider" min="0" max="100" value="70" oninput="updateDiscountInput();calculateDiscount();" class="flex-1">
                                    <div class="flex items-center space-x-1">
                                        <input type="number" id="discountInput" value="70" min="0" max="100" class="w-16 px-2 py-2 border rounded-lg text-center" oninput="updateDiscountSlider();calculateDiscount();">
                                        <span class="text-gray-500">%</span>
                                    </div>
                                </div>
                                <div id="discountLabel" class="text-sm text-gray-500 mt-1">= 70折 = 30% off</div>
                            </div>
                            <div class="p-4 bg-gradient-to-r from-pink-50 to-purple-50 rounded-xl">
                                <div class="text-sm text-gray-600 mb-1">折後價格</div>
                                <div id="finalPrice" class="text-3xl font-bold text-gray-800">¥0</div>
                                <div id="savedAmount" class="text-sm text-green-600 mt-1">節省 ¥0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <!-- 新增旅程彈窗 -->
    <div id="createTripModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeModal('createTripModal')"></div>
        <div class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between p-6 border-b">
                <h2 class="text-2xl font-semibold text-gray-800">新增旅程</h2>
                <button onclick="closeModal('createTripModal')" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form id="createTripForm" class="p-6 space-y-5" onsubmit="createTrip(event)">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">旅程標題 *</label>
                    <input type="text" id="tripTitle" placeholder="例：2026 京都春季之旅" class="w-full px-4 py-3 border rounded-xl" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">開始日期 *</label>
                        <input type="date" id="tripStartDate" class="w-full px-4 py-3 border rounded-xl" required onchange="updateTripDays()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">結束日期 *</label>
                        <input type="date" id="tripEndDate" class="w-full px-4 py-3 border rounded-xl" required onchange="updateTripDays()">
                    </div>
                </div>
                <div id="tripDaysDisplay" class="hidden items-center space-x-2 text-sm text-gray-600 bg-accent-warm/30 px-4 py-2 rounded-lg">
                    <i data-lucide="calendar" class="w-4 h-4"></i>
                    <span id="tripDaysCount">共 0 天</span>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">封面圖片</label>
                    <div id="coverPreview" class="hidden relative mb-2">
                        <img id="coverImage" src="" class="w-full h-48 object-cover rounded-xl">
                        <button type="button" onclick="clearCoverImage()" class="absolute top-2 right-2 w-8 h-8 bg-white rounded-full flex items-center justify-center shadow-md">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <label id="coverUploadBtn" class="block w-full h-32 border-2 border-dashed rounded-xl hover:border-primary cursor-pointer">
                        <div class="h-full flex flex-col items-center justify-center text-gray-500">
                            <i data-lucide="upload" class="w-8 h-8 mb-2"></i>
                            <span class="text-sm">點擊上傳圖片</span>
                        </div>
                        <input type="file" accept="image/*" class="hidden" onchange="handleCoverUpload(event)">
                    </label>
                </div>
                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="closeModal('createTripModal')" class="flex-1 px-4 py-3 border rounded-xl font-medium text-gray-700 hover:bg-gray-50">取消</button>
                    <button type="submit" class="flex-1 px-4 py-3 bg-primary text-white rounded-xl font-medium hover:bg-primary-dark">建立旅程</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 編輯旅程彈窗 -->
    <div id="editTripModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeModal('editTripModal')"></div>
        <div class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between p-6 border-b">
                <h2 class="text-2xl font-semibold text-gray-800">編輯旅程</h2>
                <button onclick="closeModal('editTripModal')" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form id="editTripForm" class="p-6 space-y-5" onsubmit="saveEditTrip(event)">
                <input type="hidden" id="editTripId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">旅程標題 *</label>
                    <input type="text" id="editTripTitle" class="w-full px-4 py-3 border rounded-xl" required>
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">開始日期 *</label>
                        <input type="date" id="editTripStartDate" class="w-full px-4 py-3 border rounded-xl" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">結束日期 *</label>
                        <input type="date" id="editTripEndDate" class="w-full px-4 py-3 border rounded-xl" required>
                    </div>
                </div>
                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="closeModal('editTripModal')" class="flex-1 px-4 py-3 border rounded-xl font-medium text-gray-700 hover:bg-gray-50">取消</button>
                    <button type="submit" class="flex-1 px-4 py-3 bg-primary text-white rounded-xl font-medium hover:bg-primary-dark">儲存</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 新增活動彈窗 -->
    <div id="addActivityModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeModal('addActivityModal')"></div>
        <div class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between p-6 border-b">
                <h2 class="text-2xl font-semibold text-gray-800">新增活動</h2>
                <button onclick="closeModal('addActivityModal')" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form id="addActivityForm" class="p-6 space-y-5" onsubmit="addActivity(event)">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">活動類型 *</label>
                    <div class="grid grid-cols-5 gap-2">
                        <button type="button" onclick="selectActivityType('food')" class="activity-type-btn p-3 rounded-xl border-2 border-gray-200 text-gray-600" data-type="food">
                            <i data-lucide="utensils" class="w-6 h-6 mx-auto mb-1"></i>
                            <div class="text-xs">餐廳</div>
                        </button>
                        <button type="button" onclick="selectActivityType('sightseeing')" class="activity-type-btn p-3 rounded-xl border-2 bg-category-sightseeing border-transparent text-white" data-type="sightseeing">
                            <i data-lucide="camera" class="w-6 h-6 mx-auto mb-1"></i>
                            <div class="text-xs">景點</div>
                        </button>
                        <button type="button" onclick="selectActivityType('transport')" class="activity-type-btn p-3 rounded-xl border-2 border-gray-200 text-gray-600" data-type="transport">
                            <i data-lucide="train-front" class="w-6 h-6 mx-auto mb-1"></i>
                            <div class="text-xs">交通</div>
                        </button>
                        <button type="button" onclick="selectActivityType('hotel')" class="activity-type-btn p-3 rounded-xl border-2 border-gray-200 text-gray-600" data-type="hotel">
                            <i data-lucide="bed" class="w-6 h-6 mx-auto mb-1"></i>
                            <div class="text-xs">住宿</div>
                        </button>
                        <button type="button" onclick="selectActivityType('shopping')" class="activity-type-btn p-3 rounded-xl border-2 border-gray-200 text-gray-600" data-type="shopping">
                            <i data-lucide="shopping-bag" class="w-6 h-6 mx-auto mb-1"></i>
                            <div class="text-xs">購物</div>
                        </button>
                    </div>
                    <input type="hidden" id="activityType" value="sightseeing">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">時間</label>
                    <input type="time" id="activityTime" class="w-full px-4 py-3 border rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">地點名稱 *</label>
                    <input type="text" id="activityLocation" placeholder="例：淺草寺" class="w-full px-4 py-3 border rounded-xl" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">備註</label>
                    <textarea id="activityNotes" placeholder="例：記得穿和服拍照" rows="2" class="w-full px-4 py-3 border rounded-xl resize-none"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">預計花費 (¥)</label>
                    <input type="number" id="activityCost" placeholder="0" min="0" class="w-full px-4 py-3 border rounded-xl">
                </div>
                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="closeModal('addActivityModal')" class="flex-1 px-4 py-3 border rounded-xl font-medium text-gray-700 hover:bg-gray-50">取消</button>
                    <button type="submit" class="flex-1 px-4 py-3 bg-primary text-white rounded-xl font-medium hover:bg-primary-dark">新增</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 編輯活動彈窗 -->
    <div id="editActivityModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeModal('editActivityModal')"></div>
        <div class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between p-6 border-b">
                <h2 class="text-2xl font-semibold text-gray-800">編輯活動</h2>
                <button onclick="closeModal('editActivityModal')" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            <form id="editActivityForm" class="p-6 space-y-5" onsubmit="saveEditActivity(event)">
                <input type="hidden" id="editActivityId">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">活動類型 *</label>
                    <div class="grid grid-cols-5 gap-2">
                        <button type="button" onclick="selectEditActivityType('food')" class="edit-activity-type-btn p-3 rounded-xl border-2 border-gray-200 text-gray-600" data-type="food">
                            <i data-lucide="utensils" class="w-6 h-6 mx-auto mb-1"></i>
                            <div class="text-xs">餐廳</div>
                        </button>
                        <button type="button" onclick="selectEditActivityType('sightseeing')" class="edit-activity-type-btn p-3 rounded-xl border-2 border-gray-200 text-gray-600" data-type="sightseeing">
                            <i data-lucide="camera" class="w-6 h-6 mx-auto mb-1"></i>
                            <div class="text-xs">景點</div>
                        </button>
                        <button type="button" onclick="selectEditActivityType('transport')" class="edit-activity-type-btn p-3 rounded-xl border-2 border-gray-200 text-gray-600" data-type="transport">
                            <i data-lucide="train-front" class="w-6 h-6 mx-auto mb-1"></i>
                            <div class="text-xs">交通</div>
                        </button>
                        <button type="button" onclick="selectEditActivityType('hotel')" class="edit-activity-type-btn p-3 rounded-xl border-2 border-gray-200 text-gray-600" data-type="hotel">
                            <i data-lucide="bed" class="w-6 h-6 mx-auto mb-1"></i>
                            <div class="text-xs">住宿</div>
                        </button>
                        <button type="button" onclick="selectEditActivityType('shopping')" class="edit-activity-type-btn p-3 rounded-xl border-2 border-gray-200 text-gray-600" data-type="shopping">
                            <i data-lucide="shopping-bag" class="w-6 h-6 mx-auto mb-1"></i>
                            <div class="text-xs">購物</div>
                        </button>
                    </div>
                    <input type="hidden" id="editActivityType" value="sightseeing">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">時間</label>
                    <input type="time" id="editActivityTime" class="w-full px-4 py-3 border rounded-xl">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">地點名稱 *</label>
                    <input type="text" id="editActivityLocation" class="w-full px-4 py-3 border rounded-xl" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">備註</label>
                    <textarea id="editActivityNotes" rows="2" class="w-full px-4 py-3 border rounded-xl resize-none"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">預計花費 (¥)</label>
                    <input type="number" id="editActivityCost" min="0" class="w-full px-4 py-3 border rounded-xl">
                </div>
                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="closeModal('editActivityModal')" class="flex-1 px-4 py-3 border rounded-xl font-medium text-gray-700 hover:bg-gray-50">取消</button>
                    <button type="submit" class="flex-1 px-4 py-3 bg-primary text-white rounded-xl font-medium hover:bg-primary-dark">儲存</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="toastContainer" class="fixed bottom-4 left-1/2 -translate-x-1/2 z-50"></div>
    <script>
        // ==================== 初始化 ====================
        lucide.createIcons();
        
        // ==================== 數據 ====================
        let trips = JSON.parse(localStorage.getItem('japanTrips')) || [];
        let currentTripId = null;
        let selectedDay = 1;
        let selectedActivityType = 'sightseeing';
        let editActivityType = 'sightseeing';
        let budgetChart = null;
        let sortableInstance = null;
        
        let checklist = JSON.parse(localStorage.getItem('checklist')) || [
            { id: '1', item: '護照、簽證', completed: false },
            { id: '2', item: '信用卡、現金', completed: false },
            { id: '3', item: '手機、充電器', completed: false },
            { id: '4', item: '行李打包', completed: false },
            { id: '5', item: '飯店預訂確認', completed: false },
            { id: '6', item: '機票確認', completed: false },
            { id: '7', item: '常用藥品', completed: false },
            { id: '8', item: '相機、記憶卡', completed: false },
            { id: '9', item: '雨具', completed: false },
            { id: '10', item: '轉接頭', completed: false },
        ];
        
        const typeConfig = {
            food: { icon: 'utensils', label: '餐廳', color: '#FF8C42' },
            sightseeing: { icon: 'camera', label: '景點', color: '#4A90E2' },
            transport: { icon: 'train-front', label: '交通', color: '#50C878' },
            hotel: { icon: 'bed', label: '住宿', color: '#9B59B6' },
            shopping: { icon: 'shopping-bag', label: '購物', color: '#FF69B4' },
        };
        
        // ==================== 工具函數 ====================
        function saveData() {
            localStorage.setItem('japanTrips', JSON.stringify(trips));
            localStorage.setItem('checklist', JSON.stringify(checklist));
        }
        
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast bg-gray-800 text-white px-4 py-2 rounded-lg shadow-lg mb-2';
            toast.textContent = message;
            document.getElementById('toastContainer').appendChild(toast);
            setTimeout(() => toast.remove(), 2500);
        }
        
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0;
                return (c == 'x' ? r : (r & 0x3 | 0x8)).toString(16);
            });
        }
        
        // ==================== 頁面與選單 ====================
        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageName)?.classList.add('active');
            
            document.querySelectorAll('.nav-item, .mobile-nav-item').forEach(n => {
                const isTarget = n.dataset.page === pageName;
                n.classList.toggle('active', isTarget);
                n.classList.toggle('bg-primary', isTarget);
                n.classList.toggle('text-white', isTarget);
                n.classList.toggle('text-gray-600', !isTarget);
            });
            
            if (pageName === 'dashboard') renderTrips();
            else if (pageName === 'trip') renderTripDetail();
            else if (pageName === 'budget') renderBudget();
            else if (pageName === 'toolbox') renderChecklist();
            
            lucide.createIcons();
        }
        
        function toggleMobileMenu() {
            document.getElementById('mobileMenu').classList.toggle('hidden');
        }
        
        function openModal(id) {
            document.getElementById(id).classList.add('active');
            lucide.createIcons();
        }
        
        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }
        
        function closeAllDropdowns() {
            document.querySelectorAll('.trip-dropdown').forEach(d => d.classList.add('hidden'));
        }
        
        document.addEventListener('click', e => {
            if (!e.target.closest('.dropdown-trigger')) closeAllDropdowns();
        });
        
        // ==================== 旅程管理 ====================
        function renderTrips() {
            const grid = document.getElementById('tripGrid');
            grid.innerHTML = '';
            
            trips.forEach(trip => {
                const startDate = new Date(trip.startDate);
                const endDate = new Date(trip.endDate);
                const days = Math.ceil((endDate - startDate) / 86400000) + 1;
                const today = new Date(); today.setHours(0,0,0,0);
                const daysUntil = Math.ceil((startDate - today) / 86400000);
                const totalActivities = (trip.dailyItinerary || []).reduce((sum, d) => sum + (d.activities?.length || 0), 0);
                const progress = Math.min((totalActivities / (days * 3)) * 100, 100);
                
                const card = document.createElement('div');
                card.className = 'bg-white rounded-2xl overflow-hidden card-shadow hover:shadow-lg transition-all cursor-pointer relative';
                card.innerHTML = `
                    <div class="h-48 bg-gradient-to-br from-primary/20 to-accent-warm relative" onclick="openTrip('${trip.id}')">
                        ${trip.coverImage ? `<img src="${trip.coverImage}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center"><i data-lucide="map-pin" class="w-16 h-16 text-primary/40"></i></div>`}
                    </div>
                    <div class="absolute top-3 right-3">
                        <button onclick="event.stopPropagation(); toggleTripDropdown('${trip.id}')" class="dropdown-trigger w-8 h-8 bg-white/90 rounded-full flex items-center justify-center shadow-md">
                            <i data-lucide="more-vertical" class="w-4 h-4"></i>
                        </button>
                        <div id="dropdown-${trip.id}" class="trip-dropdown hidden absolute right-0 mt-2 w-36 bg-white rounded-xl shadow-lg py-2 z-20">
                            <button onclick="event.stopPropagation(); openEditTripModal('${trip.id}')" class="w-full px-4 py-2 text-left text-sm hover:bg-gray-50 flex items-center space-x-2">
                                <i data-lucide="pencil" class="w-4 h-4"></i><span>編輯</span>
                            </button>
                            <button onclick="event.stopPropagation(); deleteTrip('${trip.id}')" class="w-full px-4 py-2 text-left text-sm hover:bg-red-50 text-red-600 flex items-center space-x-2">
                                <i data-lucide="trash-2" class="w-4 h-4"></i><span>刪除</span>
                            </button>
                        </div>
                    </div>
                    <div class="p-5" onclick="openTrip('${trip.id}')">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">${trip.title}</h3>
                        <div class="flex items-center text-sm text-gray-600 mb-3">
                            <i data-lucide="calendar" class="w-4 h-4 mr-2"></i>
                            <span>${startDate.toLocaleDateString('zh-TW')} - ${endDate.toLocaleDateString('zh-TW')}</span>
                        </div>
                        <div class="text-sm text-gray-500 mb-4">共 ${days} 天</div>
                        ${daysUntil > 0 ? `<div class="bg-accent-pink/30 rounded-lg p-3 text-center"><div class="text-2xl font-bold text-primary">${daysUntil}</div><div class="text-xs text-gray-600">天後出發</div></div>` : `<div><div class="flex justify-between text-xs text-gray-600 mb-2"><span>規劃進度</span><span>${Math.round(progress)}%</span></div><div class="h-2 bg-gray-100 rounded-full"><div class="h-full bg-primary rounded-full" style="width:${progress}%"></div></div></div>`}
                    </div>
                `;
                grid.appendChild(card);
            });
            
            const addBtn = document.createElement('button');
            addBtn.className = 'min-h-[300px] border-2 border-dashed border-primary/30 rounded-2xl flex flex-col items-center justify-center hover:border-primary/60 hover:bg-primary/5 transition-all group';
            addBtn.onclick = () => openModal('createTripModal');
            addBtn.innerHTML = `<div class="w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center mb-4 group-hover:bg-primary/20"><i data-lucide="plus" class="w-8 h-8 text-primary"></i></div><span class="text-lg font-medium text-primary">新增旅程</span>`;
            grid.appendChild(addBtn);
            lucide.createIcons();
        }
        
        function toggleTripDropdown(id) {
            const dd = document.getElementById('dropdown-' + id);
            const hidden = dd.classList.contains('hidden');
            closeAllDropdowns();
            if (hidden) dd.classList.remove('hidden');
        }
        
        function createTrip(e) {
            e.preventDefault();
            const title = document.getElementById('tripTitle').value;
            const startDate = document.getElementById('tripStartDate').value;
            const endDate = document.getElementById('tripEndDate').value;
            const coverEl = document.getElementById('coverImage');
            const coverImage = coverEl.src?.startsWith('data:') ? coverEl.src : '';
            
            const trip = { id: generateUUID(), title, startDate, endDate, coverImage, dailyItinerary: [], budget: { total: 200000 } };
            const start = new Date(startDate), end = new Date(endDate);
            const days = Math.ceil((end - start) / 86400000) + 1;
            
            for (let i = 1; i <= days; i++) {
                const d = new Date(start); d.setDate(start.getDate() + i - 1);
                trip.dailyItinerary.push({
                    day: i, date: d.toISOString().split('T')[0], activities: [],
                    weather: { condition: ['sunny','cloudy','overcast'][Math.floor(Math.random()*3)], minTemp: 5+Math.floor(Math.random()*10), maxTemp: 15+Math.floor(Math.random()*10) }
                });
            }
            
            trips.push(trip);
            saveData();
            document.getElementById('createTripForm').reset();
            clearCoverImage();
            closeModal('createTripModal');
            renderTrips();
            showToast('旅程已建立');
        }
        
        function openTrip(id) { currentTripId = id; selectedDay = 1; showPage('trip'); }
        
        function deleteTrip(id) {
            closeAllDropdowns();
            if (confirm('確定要刪除這個旅程嗎？')) {
                trips = trips.filter(t => t.id !== id);
                saveData();
                renderTrips();
                showToast('旅程已刪除');
            }
        }
        
        function openEditTripModal(id) {
            closeAllDropdowns();
            const trip = trips.find(t => t.id === id);
            if (!trip) return;
            document.getElementById('editTripId').value = id;
            document.getElementById('editTripTitle').value = trip.title;
            document.getElementById('editTripStartDate').value = trip.startDate;
            document.getElementById('editTripEndDate').value = trip.endDate;
            openModal('editTripModal');
        }
        
        function saveEditTrip(e) {
            e.preventDefault();
            const id = document.getElementById('editTripId').value;
            const trip = trips.find(t => t.id === id);
            if (!trip) return;
            
            trip.title = document.getElementById('editTripTitle').value;
            trip.startDate = document.getElementById('editTripStartDate').value;
            trip.endDate = document.getElementById('editTripEndDate').value;
            
            const start = new Date(trip.startDate), end = new Date(trip.endDate);
            const days = Math.ceil((end - start) / 86400000) + 1;
            
            while (trip.dailyItinerary.length < days) {
                const n = trip.dailyItinerary.length + 1;
                const d = new Date(start); d.setDate(start.getDate() + n - 1);
                trip.dailyItinerary.push({ day: n, date: d.toISOString().split('T')[0], activities: [], weather: { condition: 'sunny', minTemp: 10, maxTemp: 20 } });
            }
            if (trip.dailyItinerary.length > days) trip.dailyItinerary = trip.dailyItinerary.slice(0, days);
            
            saveData();
            closeModal('editTripModal');
            renderTrips();
            showToast('旅程已更新');
        }
        // ==================== 行程詳情 ====================
        function renderTripDetail() {
            const trip = trips.find(t => t.id === currentTripId);
            if (!trip) {
                document.getElementById('tripNotSelected').classList.remove('hidden');
                document.getElementById('tripContent').classList.add('hidden');
                return;
            }
            document.getElementById('tripNotSelected').classList.add('hidden');
            document.getElementById('tripContent').classList.remove('hidden');
            
            document.getElementById('tripDetailHeader').innerHTML = `<h1 class="text-3xl font-bold text-gray-800 mb-2">${trip.title}</h1><p class="text-gray-500">${new Date(trip.startDate).toLocaleDateString('zh-TW')} - ${new Date(trip.endDate).toLocaleDateString('zh-TW')}</p>`;
            
            const daySelector = document.getElementById('daySelector');
            daySelector.innerHTML = '';
            (trip.dailyItinerary || []).forEach(day => {
                const isSelected = day.day === selectedDay;
                const icons = { sunny: 'sun', cloudy: 'cloud-sun', overcast: 'cloud' };
                const btn = document.createElement('button');
                btn.className = `w-full p-4 rounded-xl text-left transition-all ${isSelected ? 'bg-gradient-to-r from-accent-warm to-accent-pink shadow-md' : 'bg-white hover:bg-gray-50 card-shadow'}`;
                btn.onclick = () => { selectedDay = day.day; renderTripDetail(); };
                btn.innerHTML = `<div class="flex items-center justify-between mb-2"><span class="text-lg font-semibold">${'Day ' + day.day}</span><i data-lucide="${icons[day.weather?.condition||'sunny']}" class="w-5 h-5"></i></div><div class="text-sm mb-1">${new Date(day.date).toLocaleDateString('zh-TW',{month:'short',day:'numeric'})}</div><div class="text-xs text-gray-500">${day.weather?.minTemp||10}° - ${day.weather?.maxTemp||20}° · ${(day.activities||[]).length} 個活動</div>`;
                daySelector.appendChild(btn);
            });
            
            document.getElementById('currentDayTitle').textContent = '第 ' + selectedDay + ' 天行程';
            const currentDay = (trip.dailyItinerary || []).find(d => d.day === selectedDay);
            if (currentDay?.weather) {
                const cond = { sunny: '晴天', cloudy: '多雲', overcast: '陰天' };
                document.getElementById('weatherCondition').textContent = cond[currentDay.weather.condition] || '晴天';
                document.getElementById('weatherMaxTemp').textContent = currentDay.weather.maxTemp + '°';
                document.getElementById('weatherMinTemp').textContent = '最低 ' + currentDay.weather.minTemp + '°';
            }
            renderActivities();
            lucide.createIcons();
        }
        
        function renderActivities() {
            const trip = trips.find(t => t.id === currentTripId);
            const currentDay = (trip?.dailyItinerary || []).find(d => d.day === selectedDay);
            const activities = currentDay?.activities || [];
            const list = document.getElementById('activityList');
            const noAct = document.getElementById('noActivities');
            
            if (sortableInstance) { sortableInstance.destroy(); sortableInstance = null; }
            
            if (!activities.length) { list.innerHTML = ''; noAct.classList.remove('hidden'); return; }
            noAct.classList.add('hidden');
            
            list.innerHTML = activities.map((a, i) => {
                const cfg = typeConfig[a.type] || typeConfig.sightseeing;
                const isLast = i === activities.length - 1;
                return `<div class="activity-card relative pl-12" data-id="${a.id}">${!isLast ? '<div class="absolute left-[26px] top-12 bottom-0 w-0.5 bg-gray-200"></div>' : ''}<div class="absolute left-4 top-4 w-6 h-6 rounded-full flex items-center justify-center shadow-md" style="background:${cfg.color}"><div class="w-2 h-2 bg-white rounded-full"></div></div><div class="bg-white rounded-xl p-4 card-shadow border-l-4" style="border-left-color:${cfg.color}"><div class="flex items-start justify-between"><div class="flex-1"><div class="flex items-center space-x-3 mb-3"><div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background:${cfg.color}20"><i data-lucide="${cfg.icon}" class="w-5 h-5" style="color:${cfg.color}"></i></div><div><div class="text-xs text-gray-500">${cfg.label}</div><div class="font-semibold text-gray-800">${a.location}</div></div></div><div class="space-y-1 text-sm">${a.time ? `<div class="flex items-center text-gray-600"><i data-lucide="clock" class="w-4 h-4 mr-2"></i>${a.time}</div>` : ''}${a.notes ? `<div class="flex items-start text-gray-600"><i data-lucide="file-text" class="w-4 h-4 mr-2 mt-0.5"></i>${a.notes}</div>` : ''}${a.cost > 0 ? `<div class="flex items-center text-gray-600"><i data-lucide="wallet" class="w-4 h-4 mr-2"></i>¥${a.cost.toLocaleString()}</div>` : ''}</div></div><div class="flex items-center space-x-1 flex-shrink-0"><div class="drag-handle p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-100 rounded-lg"><i data-lucide="grip-vertical" class="w-5 h-5"></i></div><button onclick="openEditActivityModal('${a.id}')" class="p-2 hover:bg-blue-50 rounded-lg text-gray-400 hover:text-blue-500"><i data-lucide="pencil" class="w-4 h-4"></i></button><button onclick="deleteActivity('${a.id}')" class="p-2 hover:bg-red-50 rounded-lg text-gray-400 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div></div></div></div>`;
            }).join('');
            
            sortableInstance = new Sortable(list, {
                animation: 150, handle: '.drag-handle', ghostClass: 'sortable-ghost',
                onEnd: function(evt) {
                    if (evt.oldIndex !== evt.newIndex) {
                        const arr = [...currentDay.activities];
                        const [removed] = arr.splice(evt.oldIndex, 1);
                        arr.splice(evt.newIndex, 0, removed);
                        currentDay.activities = arr;
                        saveData();
                        showToast('順序已更新');
                        renderActivities();
                    }
                }
            });
            lucide.createIcons();
        }
        
        function selectActivityType(type) {
            selectedActivityType = type;
            document.getElementById('activityType').value = type;
            document.querySelectorAll('.activity-type-btn').forEach(btn => {
                const isT = btn.dataset.type === type;
                btn.className = `activity-type-btn p-3 rounded-xl border-2 transition-all ${isT ? 'bg-category-' + type + ' border-transparent text-white' : 'border-gray-200 text-gray-600'}`;
            });
            lucide.createIcons();
        }
        
        function selectEditActivityType(type) {
            editActivityType = type;
            document.getElementById('editActivityType').value = type;
            document.querySelectorAll('.edit-activity-type-btn').forEach(btn => {
                const isT = btn.dataset.type === type;
                btn.className = `edit-activity-type-btn p-3 rounded-xl border-2 transition-all ${isT ? 'bg-category-' + type + ' border-transparent text-white' : 'border-gray-200 text-gray-600'}`;
            });
            lucide.createIcons();
        }
        
        function addActivity(e) {
            e.preventDefault();
            const trip = trips.find(t => t.id === currentTripId);
            const day = (trip?.dailyItinerary || []).find(d => d.day === selectedDay);
            if (!day) return;
            day.activities.push({
                id: generateUUID(),
                type: document.getElementById('activityType').value,
                time: document.getElementById('activityTime').value,
                location: document.getElementById('activityLocation').value,
                notes: document.getElementById('activityNotes').value,
                cost: parseInt(document.getElementById('activityCost').value) || 0
            });
            saveData();
            document.getElementById('addActivityForm').reset();
            selectActivityType('sightseeing');
            closeModal('addActivityModal');
            renderActivities();
            showToast('活動已新增');
        }
        
        function openEditActivityModal(id) {
            const trip = trips.find(t => t.id === currentTripId);
            const day = (trip?.dailyItinerary || []).find(d => d.day === selectedDay);
            const act = (day?.activities || []).find(a => a.id === id);
            if (!act) return;
            document.getElementById('editActivityId').value = id;
            document.getElementById('editActivityTime').value = act.time || '';
            document.getElementById('editActivityLocation').value = act.location || '';
            document.getElementById('editActivityNotes').value = act.notes || '';
            document.getElementById('editActivityCost').value = act.cost || 0;
            selectEditActivityType(act.type || 'sightseeing');
            openModal('editActivityModal');
        }
        
        function saveEditActivity(e) {
            e.preventDefault();
            const id = document.getElementById('editActivityId').value;
            const trip = trips.find(t => t.id === currentTripId);
            const day = (trip?.dailyItinerary || []).find(d => d.day === selectedDay);
            const act = (day?.activities || []).find(a => a.id === id);
            if (!act) return;
            act.type = document.getElementById('editActivityType').value;
            act.time = document.getElementById('editActivityTime').value;
            act.location = document.getElementById('editActivityLocation').value;
            act.notes = document.getElementById('editActivityNotes').value;
            act.cost = parseInt(document.getElementById('editActivityCost').value) || 0;
            saveData();
            closeModal('editActivityModal');
            renderActivities();
            showToast('活動已更新');
        }
        
        function deleteActivity(id) {
            if (confirm('確定刪除？')) {
                const trip = trips.find(t => t.id === currentTripId);
                const day = (trip?.dailyItinerary || []).find(d => d.day === selectedDay);
                if (day) { day.activities = day.activities.filter(a => a.id !== id); saveData(); renderActivities(); showToast('已刪除'); }
            }
        }
        
        // ==================== 預算 ====================
        function renderBudget() {
            const sel = document.getElementById('budgetTripSelect');
            sel.innerHTML = trips.map(t => `<option value="${t.id}">${t.title}</option>`).join('');
            if (!trips.length) { document.getElementById('budgetNoTrips').classList.remove('hidden'); document.getElementById('budgetContent').classList.add('hidden'); return; }
            document.getElementById('budgetNoTrips').classList.add('hidden');
            document.getElementById('budgetContent').classList.remove('hidden');
            updateBudgetDisplay();
        }
        
        function updateBudgetDisplay() {
            const trip = trips.find(t => t.id === document.getElementById('budgetTripSelect').value);
            if (!trip) return;
            const spending = { food: 0, transport: 0, accommodation: 0, sightseeing: 0, shopping: 0, other: 0 };
            (trip.dailyItinerary || []).forEach(d => (d.activities || []).forEach(a => { const t = a.type === 'hotel' ? 'accommodation' : a.type; spending[t] = (spending[t] || 0) + (a.cost || 0); }));
            const totalSpent = Object.values(spending).reduce((s, v) => s + v, 0);
            const totalBudget = trip.budget?.total || 200000;
            const remaining = totalBudget - totalSpent;
            
            document.getElementById('totalBudget').textContent = '¥' + totalBudget.toLocaleString();
            document.getElementById('totalSpent').textContent = '¥' + totalSpent.toLocaleString();
            document.getElementById('spentPercentage').textContent = ((totalSpent / totalBudget) * 100).toFixed(1) + '% 已使用';
            document.getElementById('remainingBudget').textContent = '¥' + Math.abs(remaining).toLocaleString();
            document.getElementById('remainingLabel').textContent = remaining < 0 ? '超支金額' : '剩餘預算';
            document.getElementById('remainingCard').className = (remaining < 0 ? 'bg-red-50' : 'bg-white') + ' rounded-2xl p-6 card-shadow';
            document.getElementById('budgetInput').value = totalBudget;
            
            const cats = { food: { label: '餐飲', color: '#FF8C42', icon: 'utensils' }, transport: { label: '交通', color: '#50C878', icon: 'train-front' }, accommodation: { label: '住宿', color: '#9B59B6', icon: 'bed' }, sightseeing: { label: '觀光', color: '#4A90E2', icon: 'camera' }, shopping: { label: '購物', color: '#FF69B4', icon: 'shopping-bag' }, other: { label: '其他', color: '#95A5A6', icon: 'package' } };
            document.getElementById('categoryList').innerHTML = Object.entries(cats).map(([k, c]) => {
                const spent = spending[k] || 0, pct = totalSpent ? (spent / totalSpent * 100) : 0;
                return `<div class="flex items-center space-x-4"><div class="w-10 h-10 rounded-xl flex items-center justify-center" style="background:${c.color}20"><i data-lucide="${c.icon}" class="w-5 h-5" style="color:${c.color}"></i></div><div class="flex-1"><div class="flex justify-between text-sm mb-1"><span class="font-medium">${c.label}</span><span class="text-gray-500">¥${spent.toLocaleString()} (${pct.toFixed(1)}%)</span></div><div class="h-2 bg-gray-100 rounded-full"><div class="h-full rounded-full" style="width:${pct}%;background:${c.color}"></div></div></div></div>`;
            }).join('');
            
            if (budgetChart) budgetChart.destroy();
            const pieData = Object.entries(spending).filter(([_, v]) => v > 0).map(([k, v]) => ({ label: cats[k].label, value: v, color: cats[k].color }));
            if (pieData.length) {
                budgetChart = new Chart(document.getElementById('budgetPieChart'), {
                    type: 'doughnut',
                    data: { labels: pieData.map(d => d.label), datasets: [{ data: pieData.map(d => d.value), backgroundColor: pieData.map(d => d.color), borderWidth: 0 }] },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } }, cutout: '60%' }
                });
            }
            lucide.createIcons();
        }
        
        function saveBudget() {
            const trip = trips.find(t => t.id === document.getElementById('budgetTripSelect').value);
            if (trip) { trip.budget = { total: parseInt(document.getElementById('budgetInput').value) || 200000 }; saveData(); updateBudgetDisplay(); showToast('預算已儲存'); }
        }
        
        // ==================== 檢查清單 ====================
        function renderChecklist() {
            const completed = checklist.filter(i => i.completed).length;
            document.getElementById('checklistProgress').textContent = completed + '/' + checklist.length;
            document.getElementById('checklistProgressBar').style.width = (checklist.length ? (completed / checklist.length * 100) : 0) + '%';
            document.getElementById('checklistItems').innerHTML = checklist.map(i => `<button onclick="toggleChecklistItem('${i.id}')" class="w-full flex items-center space-x-3 p-3 rounded-xl ${i.completed ? 'bg-green-50' : 'bg-gray-50 hover:bg-gray-100'}"><i data-lucide="${i.completed ? 'check-circle-2' : 'circle'}" class="w-5 h-5 ${i.completed ? 'text-green-500' : 'text-gray-400'}"></i><span class="text-sm text-left flex-1 ${i.completed ? 'text-gray-400 line-through' : ''}">${i.item}</span></button>`).join('');
            lucide.createIcons();
        }
        
        function toggleChecklistItem(id) { checklist = checklist.map(i => i.id === id ? { ...i, completed: !i.completed } : i); saveData(); renderChecklist(); }
        
        function addChecklistItem() {
            const input = document.getElementById('newChecklistItem'), val = input.value.trim();
            if (val) { checklist.push({ id: generateUUID(), item: val, completed: false }); saveData(); input.value = ''; renderChecklist(); }
        }
        
        // ==================== 貨幣/折扣 ====================
        function convertJpyToHkd() { const jpy = parseFloat(document.getElementById('jpyAmount').value) || 0, rate = parseFloat(document.getElementById('exchangeRate').value) || 0.051; document.getElementById('hkdAmount').value = (jpy * rate).toFixed(2); }
        function convertHkdToJpy() { const hkd = parseFloat(document.getElementById('hkdAmount').value) || 0, rate = parseFloat(document.getElementById('exchangeRate').value) || 0.051; document.getElementById('jpyAmount').value = Math.round(hkd / rate); }
        function calculateCurrencyExpression() { try { const r = Function('"use strict";return(' + document.getElementById('currencyExpression').value.replace(/[^0-9+\-*/().]/g, '') + ')')(); if (!isNaN(r)) { document.getElementById('jpyAmount').value = r; convertJpyToHkd(); } } catch (e) {} }
        function calculateDiscount() { const p = parseFloat(document.getElementById('originalPrice').value) || 0, d = parseFloat(document.getElementById('discountInput').value) || 0, f = Math.round(p * d / 100); document.getElementById('finalPrice').textContent = '¥' + f.toLocaleString(); document.getElementById('savedAmount').textContent = '節省 ¥' + (p - f).toLocaleString(); document.getElementById('discountLabel').textContent = '= ' + d + '折 = ' + (100 - d) + '% off'; }
        function updateDiscountInput() { document.getElementById('discountInput').value = document.getElementById('discountSlider').value; }
        function updateDiscountSlider() { document.getElementById('discountSlider').value = document.getElementById('discountInput').value; }
        function calculateDiscountExpression() { try { const r = Function('"use strict";return(' + document.getElementById('discountExpression').value.replace(/[^0-9+\-*/().]/g, '') + ')')(); if (!isNaN(r)) { document.getElementById('originalPrice').value = r; calculateDiscount(); } } catch (e) {} }
        
        // ==================== 翻譯 ====================
        const jpDict = { 'こんにちは': '你好', 'こんばんは': '晚上好', 'おはよう': '早安', 'ありがとう': '謝謝', 'ありがとうございます': '非常感謝', 'すみません': '不好意思', 'ごめんなさい': '對不起', 'いくらですか': '多少錢？', 'これをください': '我要這個', 'お会計お願いします': '請結帳', '美味しい': '好吃', 'おいしい': '好吃', 'トイレはどこですか': '廁所在哪裡？', 'トイレ': '廁所', '駅はどこですか': '車站在哪裡？', '駅': '車站', '電車': '電車', 'バス': '公車', 'タクシー': '計程車', '右': '右', '左': '左', 'まっすぐ': '直走', '近く': '附近', 'チェックイン': '入住', 'チェックアウト': '退房', '予約': '預約', '助けて': '救命', '警察': '警察', '病院': '醫院', 'はい': '是', 'いいえ': '不是', 'お願いします': '拜託了', 'わかりません': '我不懂', '写真を撮ってもいいですか': '可以拍照嗎？', '大丈夫': '沒關係', 'メニュー': '菜單', 'お水': '水', '注文': '點餐' };
        
        async function translateText() {
            const src = document.getElementById('sourceText').value.trim();
            if (!src) { showToast('請輸入文字'); return; }
            const btn = document.getElementById('translateBtn'), txt = document.getElementById('translateBtnText'), spin = document.getElementById('translateSpinner');
            btn.disabled = true; txt.textContent = '翻譯中...'; spin.classList.remove('hidden');
            document.getElementById('translationResult').classList.add('hidden');
            
            try {
                const sl = document.getElementById('sourceLang').value, tl = document.getElementById('targetLang').value;
                const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(src)}&langpair=${sl}|${tl}`);
                const data = await res.json();
                if (data.responseStatus === 200 && data.responseData?.translatedText) {
                    document.getElementById('translatedText').textContent = data.responseData.translatedText;
                    document.getElementById('translationResult').classList.remove('hidden');
                } else throw new Error();
            } catch (e) {
                const local = jpDict[src];
                if (local) { document.getElementById('translatedText').textContent = local; document.getElementById('translationResult').classList.remove('hidden'); }
                else { let found = null; for (const [k, v] of Object.entries(jpDict)) { if (src.includes(k)) { found = v + ' (' + k + ')'; break; } } if (found) { document.getElementById('translatedText').textContent = found; document.getElementById('translationResult').classList.remove('hidden'); } else showToast('翻譯失敗，請檢查網路'); }
            } finally { btn.disabled = false; txt.textContent = '翻譯'; spin.classList.add('hidden'); lucide.createIcons(); }
        }
        
        function quickTranslate(t) { document.getElementById('sourceText').value = t; translateText(); }
        function copyTranslation() { navigator.clipboard.writeText(document.getElementById('translatedText').textContent).then(() => showToast('已複製')).catch(() => showToast('複製失敗')); }
        
        // ==================== 封面圖片 ====================
        function handleCoverUpload(e) { const f = e.target.files?.[0]; if (f) { const r = new FileReader(); r.onloadend = () => { document.getElementById('coverImage').src = r.result; document.getElementById('coverPreview').classList.remove('hidden'); document.getElementById('coverUploadBtn').classList.add('hidden'); }; r.readAsDataURL(f); } lucide.createIcons(); }
        function clearCoverImage() { document.getElementById('coverImage').src = ''; document.getElementById('coverPreview').classList.add('hidden'); document.getElementById('coverUploadBtn').classList.remove('hidden'); lucide.createIcons(); }
        function updateTripDays() { const s = document.getElementById('tripStartDate').value, e = document.getElementById('tripEndDate').value; if (s && e) { const d = Math.ceil((new Date(e) - new Date(s)) / 86400000) + 1; if (d > 0) { document.getElementById('tripDaysCount').textContent = '共 ' + d + ' 天'; document.getElementById('tripDaysDisplay').classList.remove('hidden'); document.getElementById('tripDaysDisplay').classList.add('flex'); } else document.getElementById('tripDaysDisplay').classList.add('hidden'); } lucide.createIcons(); }
        
        // ==================== 初始化 ====================
        document.addEventListener('DOMContentLoaded', () => { renderTrips(); lucide.createIcons(); });
    </script>
</body>
</html>
