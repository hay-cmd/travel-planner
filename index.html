<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>我的旅遊規劃 - My Trip Planner</title>
    
    <!-- 字體 -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <!-- Chart.js for Pie Chart -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- SortableJS for Drag & Drop -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        base: {
                            DEFAULT: '#FAF9F6',
                            secondary: '#F5F5F5',
                        },
                        primary: {
                            DEFAULT: '#8B7355',
                            light: '#A68968',
                            dark: '#6D5C44',
                        },
                        accent: {
                            DEFAULT: '#D3D3D3',
                            warm: '#E8E4C6',
                            pink: '#FFE4E1',
                        },
                        category: {
                            food: '#FF8C42',
                            sightseeing: '#4A90E2',
                            transport: '#50C878',
                            hotel: '#9B59B6',
                            shopping: '#FF69B4',
                            other: '#95A5A6',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans JP', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style>
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
            background-color: #FAF9F6;
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
        }
        
        .card-shadow {
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.05);
        }
        
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .nav-item.active {
            background-color: #8B7355;
            color: white;
        }
        
        .modal {
            display: none;
        }
        
        .modal.active {
            display: flex;
        }
        
        .activity-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .activity-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .sortable-ghost {
            opacity: 0.4;
        }
        
        .sortable-chosen {
            background-color: #f0f9ff;
        }
        
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 6px;
            background: #e5e7eb;
            border-radius: 3px;
            outline: none;
        }
        
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: #8B7355;
            border-radius: 50%;
            cursor: pointer;
        }
    </style>
</head>
<body class="antialiased">
    <div class="flex h-screen overflow-hidden">
        <!-- 側邊欄 (桌面版) -->
        <aside id="sidebar" class="hidden lg:flex w-64 h-screen bg-white border-r border-gray-200 flex-col flex-shrink-0">
            <!-- Logo -->
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 bg-primary rounded-xl flex items-center justify-center">
                        <i data-lucide="plane" class="w-5 h-5 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-lg font-semibold text-gray-800">日本旅遊</h1>
                        <p class="text-xs text-gray-500">Trip Planner</p>
                    </div>
                </div>
            </div>
            
            <!-- 導航 -->
            <nav class="flex-1 p-4 space-y-2">
                <button onclick="showPage('dashboard')" class="nav-item active w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-left" data-page="dashboard">
                    <i data-lucide="home" class="w-5 h-5"></i>
                    <span class="font-medium">首頁</span>
                </button>
                <button onclick="showPage('trip')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-gray-50 text-left" data-page="trip">
                    <i data-lucide="calendar" class="w-5 h-5"></i>
                    <span class="font-medium">行程規劃</span>
                </button>
                <button onclick="showPage('budget')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-gray-50 text-left" data-page="budget">
                    <i data-lucide="wallet" class="w-5 h-5"></i>
                    <span class="font-medium">預算追蹤</span>
                </button>
                <button onclick="showPage('toolbox')" class="nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 text-gray-600 hover:bg-gray-50 text-left" data-page="toolbox">
                    <i data-lucide="wrench" class="w-5 h-5"></i>
                    <span class="font-medium">旅行工具</span>
                </button>
            </nav>
            
            <!-- 底部提示 -->
            <div class="p-4">
                <div class="bg-gradient-to-br from-accent-pink to-accent-warm rounded-2xl p-4">
                    <p class="text-sm font-medium text-gray-700 mb-1">✨ 開始規劃您的旅程</p>
                    <p class="text-xs text-gray-600">探索世界，創造美好回憶</p>
                </div>
            </div>
        </aside>
        
        <!-- 主內容區 -->
        <main class="flex-1 overflow-y-auto">
            <!-- 移動版頭部 -->
            <header class="lg:hidden glass border-b border-gray-200 sticky top-0 z-40">
                <div class="flex items-center justify-between p-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center">
                            <i data-lucide="plane" class="w-4 h-4 text-white"></i>
                        </div>
                        <span class="font-semibold text-gray-800">旅遊</span>
                    </div>
                    <button onclick="toggleMobileMenu()" class="p-2 hover:bg-gray-100 rounded-lg transition-colors">
                        <i data-lucide="menu" class="w-6 h-6"></i>
                    </button>
                </div>
            </header>
            
            <!-- 移動版選單 -->
            <div id="mobileMenu" class="fixed inset-0 z-50 hidden">
                <div class="absolute inset-0 bg-black/20 backdrop-blur-sm" onclick="toggleMobileMenu()"></div>
                <div class="absolute top-0 right-0 bottom-0 w-64 bg-white shadow-2xl p-6 transform transition-transform">
                    <button onclick="toggleMobileMenu()" class="absolute top-4 right-4 p-2 hover:bg-gray-100 rounded-lg">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                    <nav class="space-y-2 mt-16">
                        <button onclick="showPage('dashboard'); toggleMobileMenu();" class="mobile-nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl text-left bg-primary text-white" data-page="dashboard">
                            <i data-lucide="home" class="w-5 h-5"></i>
                            <span class="font-medium">首頁</span>
                        </button>
                        <button onclick="showPage('trip'); toggleMobileMenu();" class="mobile-nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl text-left text-gray-600 hover:bg-gray-50" data-page="trip">
                            <i data-lucide="calendar" class="w-5 h-5"></i>
                            <span class="font-medium">行程規劃</span>
                        </button>
                        <button onclick="showPage('budget'); toggleMobileMenu();" class="mobile-nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl text-left text-gray-600 hover:bg-gray-50" data-page="budget">
                            <i data-lucide="wallet" class="w-5 h-5"></i>
                            <span class="font-medium">預算追蹤</span>
                        </button>
                        <button onclick="showPage('toolbox'); toggleMobileMenu();" class="mobile-nav-item w-full flex items-center space-x-3 px-4 py-3 rounded-xl text-left text-gray-600 hover:bg-gray-50" data-page="toolbox">
                            <i data-lucide="wrench" class="w-5 h-5"></i>
                            <span class="font-medium">旅行工具</span>
                        </button>
                    </nav>
                </div>
            </div>
            
            <div class="p-4 lg:p-8">
                <!-- Dashboard 頁面 -->
                <div id="page-dashboard" class="page active max-w-7xl mx-auto">
                    <div class="mb-8">
                        <h1 class="text-3xl lg:text-4xl font-bold text-gray-800 mb-2">我的旅程</h1>
                        <p class="text-gray-500">開始規劃你的下一趟旅行</p>
                    </div>
                    
                    <div id="tripGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <!-- 旅程卡片將由 JavaScript 動態生成 -->
                        
                        <!-- 新增旅程按鈕 -->
                        <button onclick="openModal('createTripModal')" class="min-h-[300px] border-2 border-dashed border-primary/30 rounded-2xl flex flex-col items-center justify-center hover:border-primary/60 hover:bg-primary/5 transition-all duration-300 group">
                            <div class="w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center mb-4 group-hover:bg-primary/20 transition-colors">
                                <i data-lucide="plus" class="w-8 h-8 text-primary"></i>
                            </div>
                            <span class="text-lg font-medium text-primary">新增旅程</span>
                            <span class="text-sm text-gray-500 mt-1">開始規劃新的冒險</span>
                        </button>
                    </div>
                </div>
                
                <!-- Trip 頁面 -->
                <div id="page-trip" class="page max-w-7xl mx-auto">
                    <button onclick="showPage('dashboard')" class="flex items-center space-x-2 text-gray-600 hover:text-gray-800 mb-6 transition-colors">
                        <i data-lucide="arrow-left" class="w-5 h-5"></i>
                        <span>返回首頁</span>
                    </button>
                    
                    <div id="tripDetailHeader" class="mb-8">
                        <!-- 由 JavaScript 填充 -->
                    </div>
                    
                    <div id="tripNotSelected" class="text-center py-20 text-gray-500">
                        <i data-lucide="calendar" class="w-16 h-16 mx-auto mb-4 text-gray-400"></i>
                        <p>請先從首頁選擇一個旅程</p>
                    </div>
                    
                    <div id="tripContent" class="hidden grid grid-cols-1 lg:grid-cols-4 gap-6">
                        <!-- 天數選擇器 -->
                        <div class="lg:col-span-1">
                            <div id="daySelector" class="space-y-3">
                                <!-- 由 JavaScript 填充 -->
                            </div>
                        </div>
                        
                        <!-- 活動時間軸 -->
                        <div class="lg:col-span-3">
                            <div class="bg-white rounded-2xl p-6 card-shadow">
                                <div class="flex items-center justify-between mb-6">
                                    <h2 id="currentDayTitle" class="text-xl font-semibold text-gray-800">第 1 天行程</h2>
                                    <button onclick="openModal('addActivityModal')" class="flex items-center space-x-2 px-4 py-2 bg-primary text-white rounded-xl hover:bg-primary-dark transition-colors">
                                        <i data-lucide="plus" class="w-5 h-5"></i>
                                        <span>新增活動</span>
                                    </button>
                                </div>
                                
                                <!-- 天氣資訊 -->
                                <div id="weatherInfo" class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 mb-6 flex items-center justify-between">
                                    <div class="flex items-center space-x-3">
                                        <div class="w-12 h-12 bg-white rounded-full flex items-center justify-center">
                                            <i data-lucide="sun" class="w-6 h-6 text-yellow-500"></i>
                                        </div>
                                        <div>
                                            <div class="text-sm text-gray-600">今日天氣</div>
                                            <div id="weatherCondition" class="font-semibold text-gray-800">晴天</div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div id="weatherMaxTemp" class="text-2xl font-bold text-gray-800">20°</div>
                                        <div id="weatherMinTemp" class="text-sm text-gray-600">最低 10°</div>
                                    </div>
                                </div>
                                
                                <!-- 活動列表 -->
                                <div id="activityList" class="space-y-4">
                                    <!-- 由 JavaScript 填充 -->
                                </div>
                                
                                <div id="noActivities" class="text-center py-20 text-gray-500">
                                    <p>尚未新增任何活動</p>
                                    <p class="text-sm mt-2">點擊上方「新增活動」開始規劃</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Budget 頁面 -->
                <div id="page-budget" class="page max-w-7xl mx-auto">
                    <div class="mb-8">
                        <h1 class="text-3xl lg:text-4xl font-bold text-gray-800 mb-2">預算追蹤</h1>
                        <p class="text-gray-500">掌握您的旅行支出</p>
                    </div>
                    
                    <!-- 旅程選擇 -->
                    <div class="mb-6">
                        <select id="budgetTripSelect" onchange="updateBudgetDisplay()" class="px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 bg-white">
                            <!-- 由 JavaScript 填充 -->
                        </select>
                    </div>
                    
                    <div id="budgetNoTrips" class="text-center py-20 text-gray-500">
                        <i data-lucide="wallet" class="w-16 h-16 mx-auto mb-4 text-gray-400"></i>
                        <p>尚未建立任何旅程</p>
                        <p class="text-sm mt-2">請先建立旅程後再查看預算</p>
                    </div>
                    
                    <div id="budgetContent" class="hidden">
                        <!-- 預算總覽卡片 -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <div class="bg-white rounded-2xl p-6 card-shadow">
                                <div class="flex items-center justify-between mb-4">
                                    <span class="text-gray-500">總預算</span>
                                    <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
                                        <i data-lucide="wallet" class="w-5 h-5 text-blue-600"></i>
                                    </div>
                                </div>
                                <div id="totalBudget" class="text-3xl font-bold text-gray-800">¥200,000</div>
                            </div>
                            
                            <div class="bg-white rounded-2xl p-6 card-shadow">
                                <div class="flex items-center justify-between mb-4">
                                    <span class="text-gray-500">已花費</span>
                                    <div class="w-10 h-10 bg-orange-100 rounded-xl flex items-center justify-center">
                                        <i data-lucide="trending-up" class="w-5 h-5 text-orange-600"></i>
                                    </div>
                                </div>
                                <div id="totalSpent" class="text-3xl font-bold text-gray-800">¥0</div>
                                <div id="spentPercentage" class="text-sm text-gray-500 mt-1">0% 已使用</div>
                            </div>
                            
                            <div id="remainingCard" class="bg-white rounded-2xl p-6 card-shadow">
                                <div class="flex items-center justify-between mb-4">
                                    <span class="text-gray-500">剩餘預算</span>
                                    <div class="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center">
                                        <i data-lucide="trending-down" class="w-5 h-5 text-green-600"></i>
                                    </div>
                                </div>
                                <div id="remainingBudget" class="text-3xl font-bold text-gray-800">¥200,000</div>
                            </div>
                        </div>
                        
                        <!-- 圓餅圖與類別列表 -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white rounded-2xl p-6 card-shadow">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">支出分佈</h3>
                                <div class="h-[300px] flex items-center justify-center">
                                    <canvas id="budgetPieChart"></canvas>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-2xl p-6 card-shadow">
                                <h3 class="text-lg font-semibold text-gray-800 mb-4">支出類別</h3>
                                <div id="categoryList" class="space-y-4">
                                    <!-- 由 JavaScript 填充 -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- 預算設定 -->
                        <div class="bg-white rounded-2xl p-6 card-shadow mt-6">
                            <h3 class="text-lg font-semibold text-gray-800 mb-4">預算設定</h3>
                            <div class="flex items-center space-x-4">
                                <div class="flex-1">
                                    <label class="block text-sm text-gray-600 mb-2">總預算 (¥)</label>
                                    <input type="number" id="budgetInput" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50" min="0" step="10000" value="200000">
                                </div>
                                <button onclick="saveBudget()" class="px-6 py-3 bg-primary text-white rounded-xl font-medium hover:bg-primary-dark transition-colors mt-6">儲存</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Toolbox 頁面 -->
                <div id="page-toolbox" class="page max-w-7xl mx-auto">
                    <div class="mb-8">
                        <h1 class="text-3xl lg:text-4xl font-bold text-gray-800 mb-2">旅行工具箱</h1>
                        <p class="text-gray-500">實用工具，讓旅程更順暢</p>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- 出發前檢查清單 -->
                        <div class="bg-white rounded-2xl p-6 card-shadow">
                            <div class="flex items-center space-x-3 mb-4">
                                <div class="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="check-circle-2" class="w-5 h-5 text-green-600"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-800">出發前檢查清單</h3>
                            </div>
                            
                            <!-- 進度條 -->
                            <div class="mb-4">
                                <div class="flex justify-between text-sm text-gray-600 mb-2">
                                    <span>完成進度</span>
                                    <span id="checklistProgress">0/10</span>
                                </div>
                                <div class="h-2 bg-gray-100 rounded-full overflow-hidden">
                                    <div id="checklistProgressBar" class="h-full bg-green-500 rounded-full transition-all duration-300" style="width: 0%"></div>
                                </div>
                            </div>
                            
                            <!-- 清單項目 -->
                            <div id="checklistItems" class="space-y-2 max-h-[300px] overflow-y-auto scrollbar-hide mb-4">
                                <!-- 由 JavaScript 填充 -->
                            </div>
                            
                            <!-- 新增項目 -->
                            <div class="flex space-x-2">
                                <input type="text" id="newChecklistItem" placeholder="新增項目..." class="flex-1 px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-primary/50" onkeypress="if(event.key === 'Enter') addChecklistItem()">
                                <button onclick="addChecklistItem()" class="px-3 py-2 bg-primary text-white rounded-lg hover:bg-primary-dark transition-colors">
                                    <i data-lucide="plus" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                        
                        <!-- 貨幣轉換器 -->
                        <div class="bg-white rounded-2xl p-6 card-shadow">
                            <div class="flex items-center space-x-3 mb-4">
                                <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="arrow-left-right" class="w-5 h-5 text-blue-600"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-800">貨幣轉換器</h3>
                            </div>
                            
                            <!-- 匯率設定 -->
                            <div class="mb-4 p-3 bg-gray-50 rounded-xl">
                                <div class="flex items-center justify-between">
                                    <span class="text-sm text-gray-600">當前匯率</span>
                                    <div class="flex items-center space-x-2">
                                        <span class="text-sm">1 JPY =</span>
                                        <input type="number" id="exchangeRate" value="0.051" step="0.001" class="w-20 px-2 py-1 border border-gray-300 rounded text-sm" onchange="convertCurrency()">
                                        <span class="text-sm">HKD</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- 計算機輸入 -->
                            <div class="mb-4">
                                <label class="block text-sm text-gray-600 mb-2">
                                    <i data-lucide="calculator" class="w-4 h-4 inline mr-1"></i>
                                    計算機（支援算式如：500+200*3）
                                </label>
                                <div class="flex space-x-2">
                                    <input type="text" id="currencyExpression" placeholder="輸入算式..." class="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50" onkeypress="if(event.key === 'Enter') calculateCurrencyExpression()">
                                    <button onclick="calculateCurrencyExpression()" class="px-4 py-3 bg-primary text-white rounded-xl hover:bg-primary-dark transition-colors">=</button>
                                </div>
                            </div>
                            
                            <!-- 貨幣輸入 -->
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm text-gray-600 mb-2">日圓 (JPY)</label>
                                    <div class="relative">
                                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500">¥</span>
                                        <input type="number" id="jpyAmount" placeholder="0" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 text-lg" oninput="convertJpyToHkd()">
                                    </div>
                                </div>
                                
                                <div class="flex justify-center">
                                    <div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
                                        <i data-lucide="arrow-left-right" class="w-5 h-5 text-gray-500"></i>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block text-sm text-gray-600 mb-2">港幣 (HKD)</label>
                                    <div class="relative">
                                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500">$</span>
                                        <input type="number" id="hkdAmount" placeholder="0" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 text-lg" oninput="convertHkdToJpy()">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 語言翻譯器 -->
                        <div class="bg-white rounded-2xl p-6 card-shadow">
                            <div class="flex items-center space-x-3 mb-4">
                                <div class="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="languages" class="w-5 h-5 text-purple-600"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-800">語言翻譯器</h3>
                            </div>
                            
                            <p class="text-sm text-gray-500 mb-4">日文 → 繁體中文</p>
                            
                            <!-- 相片/相機區域 -->
                            <div class="mb-4">
                                <div id="cameraPreview" class="hidden relative">
                                    <video id="cameraVideo" autoplay playsinline class="w-full h-48 object-cover rounded-xl bg-black"></video>
                                    <div class="absolute bottom-2 left-1/2 -translate-x-1/2 flex space-x-2">
                                        <button onclick="captureImage()" class="px-4 py-2 bg-white rounded-full shadow-lg text-sm">拍照</button>
                                        <button onclick="stopCamera()" class="px-4 py-2 bg-red-500 text-white rounded-full shadow-lg text-sm">取消</button>
                                    </div>
                                </div>
                                
                                <div id="imagePreview" class="hidden relative">
                                    <img id="uploadedImage" src="" alt="上傳的圖片" class="w-full h-48 object-cover rounded-xl">
                                    <button onclick="clearImage()" class="absolute top-2 right-2 w-8 h-8 bg-white rounded-full flex items-center justify-center shadow-md">
                                        <i data-lucide="x" class="w-4 h-4"></i>
                                    </button>
                                </div>
                                
                                <div id="cameraButtons" class="flex space-x-2">
                                    <button onclick="startCamera()" class="flex-1 h-24 border-2 border-dashed border-gray-300 rounded-xl flex flex-col items-center justify-center hover:border-primary transition-colors">
                                        <i data-lucide="camera" class="w-6 h-6 text-gray-400 mb-1"></i>
                                        <span class="text-sm text-gray-500">開啟相機</span>
                                    </button>
                                    <label class="flex-1 h-24 border-2 border-dashed border-gray-300 rounded-xl flex flex-col items-center justify-center hover:border-primary transition-colors cursor-pointer">
                                        <i data-lucide="image" class="w-6 h-6 text-gray-400 mb-1"></i>
                                        <span class="text-sm text-gray-500">上傳相片</span>
                                        <input type="file" accept="image/*" class="hidden" onchange="handleImageUpload(event)">
                                    </label>
                                </div>
                            </div>
                            
                            <!-- 文字輸入 -->
                            <div class="mb-4">
                                <textarea id="sourceText" placeholder="輸入日文文字或使用相機/相片識別..." rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 resize-none"></textarea>
                            </div>
                            
                            <!-- 翻譯按鈕 -->
                            <button onclick="translateText()" class="w-full px-4 py-3 bg-primary text-white rounded-xl font-medium hover:bg-primary-dark transition-colors mb-4">翻譯</button>
                            
                            <!-- 翻譯結果 -->
                            <div id="translationResult" class="hidden p-4 bg-purple-50 rounded-xl">
                                <div class="text-sm text-purple-600 mb-1">翻譯結果</div>
                                <div id="translatedText" class="text-gray-800"></div>
                            </div>
                        </div>
                        
                        <!-- 折扣計算機 -->
                        <div class="bg-white rounded-2xl p-6 card-shadow">
                            <div class="flex items-center space-x-3 mb-4">
                                <div class="w-10 h-10 bg-pink-100 rounded-xl flex items-center justify-center">
                                    <i data-lucide="percent" class="w-5 h-5 text-pink-600"></i>
                                </div>
                                <h3 class="text-lg font-semibold text-gray-800">折扣計算機</h3>
                            </div>
                            
                            <!-- 計算機輸入 -->
                            <div class="mb-4">
                                <label class="block text-sm text-gray-600 mb-2">
                                    <i data-lucide="calculator" class="w-4 h-4 inline mr-1"></i>
                                    計算機（支援算式）
                                </label>
                                <div class="flex space-x-2">
                                    <input type="text" id="discountExpression" placeholder="輸入算式如：1000+500..." class="flex-1 px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50" onkeypress="if(event.key === 'Enter') calculateDiscountExpression()">
                                    <button onclick="calculateDiscountExpression()" class="px-4 py-3 bg-primary text-white rounded-xl hover:bg-primary-dark transition-colors">=</button>
                                </div>
                            </div>
                            
                            <!-- 原價輸入 -->
                            <div class="mb-4">
                                <label class="block text-sm text-gray-600 mb-2">原價 (¥)</label>
                                <div class="relative">
                                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500">¥</span>
                                    <input type="number" id="originalPrice" placeholder="0" class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 text-lg" oninput="calculateDiscount()">
                                </div>
                            </div>
                            
                            <!-- 折扣輸入 -->
                            <div class="mb-4">
                                <label class="block text-sm text-gray-600 mb-2">折扣（例如：70 = 7折 = 30% off）</label>
                                <div class="flex items-center space-x-4">
                                    <input type="range" id="discountSlider" min="0" max="100" value="70" oninput="updateDiscountInput(); calculateDiscount();" class="flex-1">
                                    <div class="flex items-center space-x-1">
                                        <input type="number" id="discountInput" value="70" min="0" max="100" class="w-16 px-2 py-2 border border-gray-300 rounded-lg text-center" oninput="updateDiscountSlider(); calculateDiscount();">
                                        <span class="text-gray-500">%</span>
                                    </div>
                                </div>
                                <div id="discountLabel" class="text-sm text-gray-500 mt-1">= 70折 = 30% off</div>
                            </div>
                            
                            <!-- 結果顯示 -->
                            <div class="p-4 bg-gradient-to-r from-pink-50 to-purple-50 rounded-xl">
                                <div class="text-sm text-gray-600 mb-1">折後價格</div>
                                <div id="finalPrice" class="text-3xl font-bold text-gray-800">¥0</div>
                                <div id="savedAmount" class="text-sm text-green-600 mt-1">節省 ¥0</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- 新增旅程彈窗 -->
    <div id="createTripModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeModal('createTripModal')"></div>
        <div class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-800">新增旅程</h2>
                <button onclick="closeModal('createTripModal')" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <form id="createTripForm" class="p-6 space-y-5" onsubmit="createTrip(event)">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">旅程標題 *</label>
                    <input type="text" id="tripTitle" placeholder="例：2026 京都春季之旅" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50" required>
                </div>
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">開始日期 *</label>
                        <input type="date" id="tripStartDate" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50" required onchange="updateTripDays()">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">結束日期 *</label>
                        <input type="date" id="tripEndDate" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50" required onchange="updateTripDays()">
                    </div>
                </div>
                
                <div id="tripDaysDisplay" class="hidden flex items-center space-x-2 text-sm text-gray-600 bg-accent-warm/30 px-4 py-2 rounded-lg">
                    <i data-lucide="calendar" class="w-4 h-4"></i>
                    <span id="tripDaysCount">共 0 天</span>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">封面圖片</label>
                    <div id="coverPreview" class="hidden relative mb-2">
                        <img id="coverImage" src="" alt="封面預覽" class="w-full h-48 object-cover rounded-xl">
                        <button type="button" onclick="clearCoverImage()" class="absolute top-2 right-2 w-8 h-8 bg-white rounded-full flex items-center justify-center shadow-md hover:bg-gray-100">
                            <i data-lucide="x" class="w-4 h-4"></i>
                        </button>
                    </div>
                    <label id="coverUploadBtn" class="block w-full h-32 border-2 border-dashed border-gray-300 rounded-xl hover:border-primary transition-colors cursor-pointer">
                        <div class="h-full flex flex-col items-center justify-center text-gray-500">
                            <i data-lucide="upload" class="w-8 h-8 mb-2"></i>
                            <span class="text-sm">點擊上傳圖片</span>
                        </div>
                        <input type="file" accept="image/*" class="hidden" onchange="handleCoverUpload(event)">
                    </label>
                </div>
                
                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="closeModal('createTripModal')" class="flex-1 px-4 py-3 border border-gray-300 rounded-xl font-medium text-gray-700 hover:bg-gray-50 transition-colors">取消</button>
                    <button type="submit" class="flex-1 px-4 py-3 bg-primary text-white rounded-xl font-medium hover:bg-primary-dark transition-colors">建立旅程</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 新增活動彈窗 -->
    <div id="addActivityModal" class="modal fixed inset-0 z-50 items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeModal('addActivityModal')"></div>
        <div class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full max-h-[90vh] overflow-y-auto">
            <div class="flex items-center justify-between p-6 border-b border-gray-200">
                <h2 class="text-2xl font-semibold text-gray-800">新增活動</h2>
                <button onclick="closeModal('addActivityModal')" class="w-8 h-8 flex items-center justify-center rounded-lg hover:bg-gray-100 transition-colors">
                    <i data-lucide="x" class="w-5 h-5"></i>
                </button>
            </div>
            
            <form id="addActivityForm" class="p-6 space-y-5" onsubmit="addActivity(event)">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-3">活動類型 *</label>
                    <div class="grid grid-cols-5 gap-2">
                        <button type="button" onclick="selectActivityType('food')" class="activity-type-btn p-3 rounded-xl border-2 transition-all border-gray-200 hover:border-gray-300 text-gray-600" data-type="food">
                            <i data-lucide="utensils-crossed" class="w-6 h-6 mx-auto mb-1"></i>
                            <div class="text-xs">餐廳</div>
                        </button>
                        <button type="button" onclick="selectActivityType('sightseeing')" class="activity-type-btn p-3 rounded-xl border-2 transition-all bg-category-sightseeing border-transparent text-white" data-type="sightseeing">
                            <i data-lucide="camera" class="w-6 h-6 mx-auto mb-1"></i>
                            <div class="text-xs">景點</div>
                        </button>
                        <button type="button" onclick="selectActivityType('transport')" class="activity-type-btn p-3 rounded-xl border-2 transition-all border-gray-200 hover:border-gray-300 text-gray-600" data-type="transport">
                            <i data-lucide="train" class="w-6 h-6 mx-auto mb-1"></i>
                            <div class="text-xs">交通</div>
                        </button>
                        <button type="button" onclick="selectActivityType('hotel')" class="activity-type-btn p-3 rounded-xl border-2 transition-all border-gray-200 hover:border-gray-300 text-gray-600" data-type="hotel">
                            <i data-lucide="hotel" class="w-6 h-6 mx-auto mb-1"></i>
                            <div class="text-xs">住宿</div>
                        </button>
                        <button type="button" onclick="selectActivityType('shopping')" class="activity-type-btn p-3 rounded-xl border-2 transition-all border-gray-200 hover:border-gray-300 text-gray-600" data-type="shopping">
                            <i data-lucide="shopping-bag" class="w-6 h-6 mx-auto mb-1"></i>
                            <div class="text-xs">購物</div>
                        </button>
                    </div>
                    <input type="hidden" id="activityType" value="sightseeing">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">時間</label>
                    <input type="time" id="activityTime" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50">
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">地點名稱 *</label>
                    <input type="text" id="activityLocation" placeholder="例：淺草寺" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50" required>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">備註</label>
                    <textarea id="activityNotes" placeholder="例：記得穿和服拍照" rows="3" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50 resize-none"></textarea>
                </div>
                
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">預計花費 (¥)</label>
                    <input type="number" id="activityCost" placeholder="0" min="0" class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-primary/50">
                </div>
                
                <div class="flex space-x-3 pt-4">
                    <button type="button" onclick="closeModal('addActivityModal')" class="flex-1 px-4 py-3 border border-gray-300 rounded-xl font-medium text-gray-700 hover:bg-gray-50 transition-colors">取消</button>
                    <button type="submit" class="flex-1 px-4 py-3 bg-primary text-white rounded-xl font-medium hover:bg-primary-dark transition-colors">新增活動</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // 初始化 Lucide 圖標
        lucide.createIcons();
        
        // 數據存儲
        let trips = JSON.parse(localStorage.getItem('japanTrips')) || [];
        let currentTripId = null;
        let selectedDay = 1;
        let selectedActivityType = 'sightseeing';
        let budgetChart = null;
        let checklist = JSON.parse(localStorage.getItem('checklist')) || [
            { id: '1', item: '護照、簽證', completed: false },
            { id: '2', item: '信用卡、現金', completed: false },
            { id: '3', item: '手機、充電器', completed: false },
            { id: '4', item: '行李打包', completed: false },
            { id: '5', item: '飯店預訂確認', completed: false },
            { id: '6', item: '機票確認', completed: false },
            { id: '7', item: '常用藥品', completed: false },
            { id: '8', item: '相機、記憶卡', completed: false },
            { id: '9', item: '雨具', completed: false },
            { id: '10', item: '轉接頭', completed: false },
        ];
        
        // 保存數據
        function saveData() {
            localStorage.setItem('japanTrips', JSON.stringify(trips));
            localStorage.setItem('checklist', JSON.stringify(checklist));
        }
        
        // 頁面切換
        function showPage(pageName) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageName).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(n => {
                n.classList.remove('active', 'bg-primary', 'text-white');
                n.classList.add('text-gray-600', 'hover:bg-gray-50');
            });
            document.querySelectorAll('.mobile-nav-item').forEach(n => {
                n.classList.remove('bg-primary', 'text-white');
                n.classList.add('text-gray-600', 'hover:bg-gray-50');
            });
            
            document.querySelectorAll(`[data-page="${pageName}"]`).forEach(n => {
                n.classList.add('active', 'bg-primary', 'text-white');
                n.classList.remove('text-gray-600', 'hover:bg-gray-50');
            });
            
            if (pageName === 'dashboard') {
                renderTrips();
            } else if (pageName === 'trip') {
                renderTripDetail();
            } else if (pageName === 'budget') {
                renderBudget();
            } else if (pageName === 'toolbox') {
                renderChecklist();
            }
            
            lucide.createIcons();
        }
        
        // 移動版選單
        function toggleMobileMenu() {
            const menu = document.getElementById('mobileMenu');
            menu.classList.toggle('hidden');
        }
        
        // 彈窗控制
        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
            lucide.createIcons();
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }
        
        // 渲染旅程卡片
        function renderTrips() {
            const grid = document.getElementById('tripGrid');
            const addBtn = grid.querySelector('button:last-child');
            
            // 清除現有卡片（保留新增按鈕）
            grid.innerHTML = '';
            
            trips.forEach(trip => {
                const startDate = new Date(trip.startDate);
                const endDate = new Date(trip.endDate);
                const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const daysUntil = Math.ceil((startDate - today) / (1000 * 60 * 60 * 24));
                
                const totalActivities = trip.dailyItinerary.reduce((sum, day) => sum + day.activities.length, 0);
                const progress = Math.min((totalActivities / (days * 3)) * 100, 100);
                
                const card = document.createElement('div');
                card.className = 'bg-white rounded-2xl overflow-hidden card-shadow hover:shadow-lg transition-all cursor-pointer';
                card.onclick = () => openTrip(trip.id);
                
                card.innerHTML = `
                    <div class="h-48 bg-gradient-to-br from-primary/20 to-accent-warm overflow-hidden relative">
                        ${trip.coverImage 
                            ? `<img src="${trip.coverImage}" alt="${trip.title}" class="w-full h-full object-cover">` 
                            : `<div class="w-full h-full flex items-center justify-center"><i data-lucide="map-pin" class="w-16 h-16 text-primary/40"></i></div>`
                        }
                        <div class="absolute top-3 right-3">
                            <button onclick="event.stopPropagation(); deleteTrip('${trip.id}')" class="w-8 h-8 bg-white/90 backdrop-blur-sm rounded-full flex items-center justify-center hover:bg-white transition-colors">
                                <i data-lucide="trash-2" class="w-4 h-4 text-red-500"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-5">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">${trip.title}</h3>
                        <div class="flex items-center text-sm text-gray-600 mb-3">
                            <i data-lucide="calendar" class="w-4 h-4 mr-2"></i>
                            <span>${startDate.toLocaleDateString('zh-TW')} - ${endDate.toLocaleDateString('zh-TW')}</span>
                        </div>
                        <div class="text-sm text-gray-500 mb-4">共 ${days} 天</div>
                        ${daysUntil > 0 
                            ? `<div class="bg-accent-pink/30 rounded-lg p-3 text-center">
                                <div class="text-2xl font-bold text-primary">${daysUntil}</div>
                                <div class="text-xs text-gray-600">天後出發</div>
                               </div>`
                            : `<div>
                                <div class="flex justify-between text-xs text-gray-600 mb-2">
                                    <span>規劃進度</span>
                                    <span>${Math.round(progress)}%</span>
                                </div>
                                <div class="h-2 bg-gray-100 rounded-full overflow-hidden">
                                    <div class="h-full bg-gradient-to-r from-primary to-primary-light rounded-full" style="width: ${progress}%"></div>
                                </div>
                               </div>`
                        }
                    </div>
                `;
                
                grid.appendChild(card);
            });
            
            // 添加新增按鈕
            const addButton = document.createElement('button');
            addButton.className = 'min-h-[300px] border-2 border-dashed border-primary/30 rounded-2xl flex flex-col items-center justify-center hover:border-primary/60 hover:bg-primary/5 transition-all duration-300 group';
            addButton.onclick = () => openModal('createTripModal');
            addButton.innerHTML = `
                <div class="w-16 h-16 rounded-full bg-primary/10 flex items-center justify-center mb-4 group-hover:bg-primary/20 transition-colors">
                    <i data-lucide="plus" class="w-8 h-8 text-primary"></i>
                </div>
                <span class="text-lg font-medium text-primary">新增旅程</span>
                <span class="text-sm text-gray-500 mt-1">開始規劃新的冒險</span>
            `;
            grid.appendChild(addButton);
            
            lucide.createIcons();
        }
        
        // 建立旅程
        function createTrip(e) {
            e.preventDefault();
            
            const title = document.getElementById('tripTitle').value;
            const startDate = document.getElementById('tripStartDate').value;
            const endDate = document.getElementById('tripEndDate').value;
            const coverImage = document.getElementById('coverImage').src || '';
            
            const trip = {
                id: crypto.randomUUID(),
                title,
                startDate,
                endDate,
                status: 'planning',
                coverImage: coverImage.startsWith('data:') ? coverImage : '',
                dailyItinerary: [],
                budget: { total: 200000, spent: 0 },
                checklist: []
            };
            
            // 初始化每天的行程
            const start = new Date(startDate);
            const end = new Date(endDate);
            const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
            
            for (let i = 1; i <= days; i++) {
                const dayDate = new Date(start);
                dayDate.setDate(start.getDate() + i - 1);
                trip.dailyItinerary.push({
                    day: i,
                    date: dayDate.toISOString().split('T')[0],
                    activities: [],
                    weather: {
                        condition: ['sunny', 'cloudy', 'overcast'][Math.floor(Math.random() * 3)],
                        minTemp: Math.floor(Math.random() * 10) + 5,
                        maxTemp: Math.floor(Math.random() * 10) + 15
                    }
                });
            }
            
            trips.push(trip);
            saveData();
            
            // 重置表單
            document.getElementById('createTripForm').reset();
            clearCoverImage();
            
            closeModal('createTripModal');
            renderTrips();
        }
        
        // 打開旅程詳情
        function openTrip(tripId) {
            currentTripId = tripId;
            selectedDay = 1;
            showPage('trip');
        }
        
        // 刪除旅程
        function deleteTrip(tripId) {
            if (confirm('確定要刪除這個旅程嗎？')) {
                trips = trips.filter(t => t.id !== tripId);
                saveData();
                renderTrips();
            }
        }
        
        // 渲染旅程詳情
        function renderTripDetail() {
            const trip = trips.find(t => t.id === currentTripId);
            
            if (!trip) {
                document.getElementById('tripNotSelected').classList.remove('hidden');
                document.getElementById('tripContent').classList.add('hidden');
                return;
            }
            
            document.getElementById('tripNotSelected').classList.add('hidden');
            document.getElementById('tripContent').classList.remove('hidden');
            
            // 標題
            document.getElementById('tripDetailHeader').innerHTML = `
                <h1 class="text-3xl lg:text-4xl font-bold text-gray-800 mb-2">${trip.title}</h1>
                <p class="text-gray-500">${new Date(trip.startDate).toLocaleDateString('zh-TW')} - ${new Date(trip.endDate).toLocaleDateString('zh-TW')}</p>
            `;
            
            // 天數選擇器
            const daySelector = document.getElementById('daySelector');
            daySelector.innerHTML = '';
            
            trip.dailyItinerary.forEach(day => {
                const isSelected = day.day === selectedDay;
                const weatherIcons = {
                    sunny: 'sun',
                    cloudy: 'cloud-sun',
                    overcast: 'cloud'
                };
                
                const dayBtn = document.createElement('button');
                dayBtn.className = `w-full p-4 rounded-xl text-left transition-all duration-200 ${isSelected ? 'bg-gradient-to-r from-accent-warm to-accent-pink shadow-md' : 'bg-white hover:bg-gray-50 card-shadow'}`;
                dayBtn.onclick = () => {
                    selectedDay = day.day;
                    renderTripDetail();
                };
                
                dayBtn.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-lg font-semibold ${isSelected ? 'text-gray-800' : 'text-gray-700'}">Day ${day.day}</span>
                        <i data-lucide="${weatherIcons[day.weather?.condition || 'sunny']}" class="w-5 h-5 ${isSelected ? 'text-gray-700' : 'text-gray-500'}"></i>
                    </div>
                    <div class="text-sm mb-2 ${isSelected ? 'text-gray-700' : 'text-gray-500'}">${new Date(day.date).toLocaleDateString('zh-TW', { month: 'short', day: 'numeric' })}</div>
                    ${day.weather ? `<div class="text-xs mb-2 ${isSelected ? 'text-gray-600' : 'text-gray-500'}">${day.weather.minTemp}° - ${day.weather.maxTemp}°</div>` : ''}
                    <div class="text-xs ${isSelected ? 'text-gray-600' : 'text-gray-500'}">${day.activities.length} 個活動</div>
                `;
                
                daySelector.appendChild(dayBtn);
            });
            
            // 當前天標題
            document.getElementById('currentDayTitle').textContent = `第 ${selectedDay} 天行程`;
            
            // 天氣
            const currentDay = trip.dailyItinerary.find(d => d.day === selectedDay);
            if (currentDay?.weather) {
                const weatherConditions = {
                    sunny: '晴天',
                    cloudy: '多雲',
                    overcast: '陰天'
                };
                document.getElementById('weatherCondition').textContent = weatherConditions[currentDay.weather.condition] || '晴天';
                document.getElementById('weatherMaxTemp').textContent = `${currentDay.weather.maxTemp}°`;
                document.getElementById('weatherMinTemp').textContent = `最低 ${currentDay.weather.minTemp}°`;
            }
            
            // 活動列表
            renderActivities();
            
            lucide.createIcons();
        }
        
        // 渲染活動列表
        function renderActivities() {
            const trip = trips.find(t => t.id === currentTripId);
            const currentDay = trip?.dailyItinerary.find(d => d.day === selectedDay);
            const activities = currentDay?.activities || [];
            
            const activityList = document.getElementById('activityList');
            const noActivities = document.getElementById('noActivities');
            
            if (activities.length === 0) {
                activityList.innerHTML = '';
                noActivities.classList.remove('hidden');
                return;
            }
            
            noActivities.classList.add('hidden');
            
            const typeConfig = {
                food: { icon: 'utensils-crossed', label: '餐廳', color: '#FF8C42' },
                sightseeing: { icon: 'camera', label: '景點', color: '#4A90E2' },
                transport: { icon: 'train', label: '交通', color: '#50C878' },
                hotel: { icon: 'hotel', label: '住宿', color: '#9B59B6' },
                shopping: { icon: 'shopping-bag', label: '購物', color: '#FF69B4' },
            };
            
            activityList.innerHTML = activities.map((activity, index) => {
                const config = typeConfig[activity.type] || typeConfig.sightseeing;
                const isLast = index === activities.length - 1;
                
                return `
                    <div class="activity-card relative pl-12" data-id="${activity.id}">
                        ${!isLast ? '<div class="absolute left-[26px] top-12 bottom-0 w-0.5 bg-gray-200"></div>' : ''}
                        <div class="absolute left-4 top-4 w-6 h-6 rounded-full flex items-center justify-center shadow-md" style="background-color: ${config.color}">
                            <div class="w-2 h-2 bg-white rounded-full"></div>
                        </div>
                        <div class="bg-white rounded-xl p-4 card-shadow hover:shadow-md transition-shadow" style="border-left: 4px solid ${config.color}">
                            <div class="flex items-start justify-between">
                                <div class="flex-1">
                                    <div class="flex items-center space-x-3 mb-3">
                                        <div class="w-10 h-10 rounded-lg flex items-center justify-center" style="background-color: ${config.color}20">
                                            <i data-lucide="${config.icon}" class="w-5 h-5" style="color: ${config.color}"></i>
                                        </div>
                                        <div>
                                            <div class="text-xs text-gray-500">${config.label}</div>
                                            <div class="font-semibold text-gray-800">${activity.location}</div>
                                        </div>
                                    </div>
                                    <div class="space-y-2 text-sm">
                                        ${activity.time ? `<div class="flex items-center text-gray-600"><i data-lucide="clock" class="w-4 h-4 mr-2"></i>${activity.time}</div>` : ''}
                                        ${activity.notes ? `<div class="flex items-start text-gray-600"><i data-lucide="map-pin" class="w-4 h-4 mr-2 mt-0.5"></i><span class="flex-1">${activity.notes}</span></div>` : ''}
                                        ${activity.cost > 0 ? `<div class="flex items-center text-gray-600"><i data-lucide="wallet" class="w-4 h-4 mr-2"></i>¥${activity.cost.toLocaleString()}</div>` : ''}
                                    </div>
                                </div>
                                <div class="flex items-start space-x-2">
                                    <div class="cursor-grab active:cursor-grabbing text-gray-400 hover:text-gray-600 drag-handle">
                                        <i data-lucide="grip-vertical" class="w-5 h-5"></i>
                                    </div>
                                    <button onclick="deleteActivity('${activity.id}')" class="p-1 hover:bg-red-50 rounded transition-colors text-gray-400 hover:text-red-500">
                                        <i data-lucide="trash-2" class="w-5 h-5"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // 初始化拖拽
            new Sortable(activityList, {
                animation: 150,
                handle: '.drag-handle',
                ghostClass: 'sortable-ghost',
                chosenClass: 'sortable-chosen',
                onEnd: function(evt) {
                    const trip = trips.find(t => t.id === currentTripId);
                    const currentDay = trip?.dailyItinerary.find(d => d.day === selectedDay);
                    if (currentDay) {
                        const activities = [...currentDay.activities];
                        const [removed] = activities.splice(evt.oldIndex, 1);
                        activities.splice(evt.newIndex, 0, removed);
                        currentDay.activities = activities;
                        saveData();
                    }
                }
            });
            
            lucide.createIcons();
        }
        
        // 選擇活動類型
        function selectActivityType(type) {
            selectedActivityType = type;
            document.getElementById('activityType').value = type;
            
            const colors = {
                food: 'bg-category-food',
                sightseeing: 'bg-category-sightseeing',
                transport: 'bg-category-transport',
                hotel: 'bg-category-hotel',
                shopping: 'bg-category-shopping'
            };
            
            document.querySelectorAll('.activity-type-btn').forEach(btn => {
                const btnType = btn.dataset.type;
                if (btnType === type) {
                    btn.className = `activity-type-btn p-3 rounded-xl border-2 transition-all ${colors[type]} border-transparent text-white`;
                } else {
                    btn.className = 'activity-type-btn p-3 rounded-xl border-2 transition-all border-gray-200 hover:border-gray-300 text-gray-600';
                }
            });
        }
        
        // 新增活動
        function addActivity(e) {
            e.preventDefault();
            
            const trip = trips.find(t => t.id === currentTripId);
            const currentDay = trip?.dailyItinerary.find(d => d.day === selectedDay);
            
            if (!currentDay) return;
            
            const activity = {
                id: crypto.randomUUID(),
                type: document.getElementById('activityType').value,
                time: document.getElementById('activityTime').value,
                location: document.getElementById('activityLocation').value,
                notes: document.getElementById('activityNotes').value,
                cost: parseInt(document.getElementById('activityCost').value) || 0
            };
            
            currentDay.activities.push(activity);
            saveData();
            
            // 重置表單
            document.getElementById('addActivityForm').reset();
            selectActivityType('sightseeing');
            
            closeModal('addActivityModal');
            renderActivities();
        }
        
        // 刪除活動
        function deleteActivity(activityId) {
            if (confirm('確定要刪除這個活動嗎？')) {
                const trip = trips.find(t => t.id === currentTripId);
                const currentDay = trip?.dailyItinerary.find(d => d.day === selectedDay);
                
                if (currentDay) {
                    currentDay.activities = currentDay.activities.filter(a => a.id !== activityId);
                    saveData();
                    renderActivities();
                }
            }
        }
        
        // 渲染預算
        function renderBudget() {
            const tripSelect = document.getElementById('budgetTripSelect');
            tripSelect.innerHTML = trips.map(t => `<option value="${t.id}">${t.title}</option>`).join('');
            
            if (trips.length === 0) {
                document.getElementById('budgetNoTrips').classList.remove('hidden');
                document.getElementById('budgetContent').classList.add('hidden');
                return;
            }
            
            document.getElementById('budgetNoTrips').classList.add('hidden');
            document.getElementById('budgetContent').classList.remove('hidden');
            
            updateBudgetDisplay();
        }
        
        function updateBudgetDisplay() {
            const tripId = document.getElementById('budgetTripSelect').value;
            const trip = trips.find(t => t.id === tripId);
            
            if (!trip) return;
            
            // 計算各類別支出
            const spending = {
                food: 0,
                transport: 0,
                accommodation: 0,
                sightseeing: 0,
                shopping: 0,
                other: 0
            };
            
            trip.dailyItinerary.forEach(day => {
                day.activities.forEach(activity => {
                    const type = activity.type === 'hotel' ? 'accommodation' : activity.type;
                    if (spending[type] !== undefined) {
                        spending[type] += activity.cost || 0;
                    } else {
                        spending.other += activity.cost || 0;
                    }
                });
            });
            
            const totalSpent = Object.values(spending).reduce((sum, val) => sum + val, 0);
            const totalBudget = trip.budget?.total || 200000;
            const remaining = totalBudget - totalSpent;
            const isOverBudget = remaining < 0;
            
            // 更新顯示
            document.getElementById('totalBudget').textContent = `¥${totalBudget.toLocaleString()}`;
            document.getElementById('totalSpent').textContent = `¥${totalSpent.toLocaleString()}`;
            document.getElementById('spentPercentage').textContent = `${((totalSpent / totalBudget) * 100).toFixed(1)}% 已使用`;
            document.getElementById('remainingBudget').textContent = `¥${Math.abs(remaining).toLocaleString()}`;
            document.getElementById('budgetInput').value = totalBudget;
            
            const remainingCard = document.getElementById('remainingCard');
            if (isOverBudget) {
                remainingCard.className = 'bg-red-50 rounded-2xl p-6 card-shadow';
                remainingCard.querySelector('span').textContent = '超支金額';
                remainingCard.querySelector('span').className = 'text-red-500';
                remainingCard.querySelector('#remainingBudget').className = 'text-3xl font-bold text-red-600';
            } else {
                remainingCard.className = 'bg-white rounded-2xl p-6 card-shadow';
                remainingCard.querySelector('span').textContent = '剩餘預算';
                remainingCard.querySelector('span').className = 'text-gray-500';
                remainingCard.querySelector('#remainingBudget').className = 'text-3xl font-bold text-gray-800';
            }
            
            // 類別列表
            const categoryConfig = {
                food: { label: '餐飲', color: '#FF8C42', icon: 'utensils-crossed' },
                transport: { label: '交通', color: '#50C878', icon: 'train' },
                accommodation: { label: '住宿', color: '#9B59B6', icon: 'hotel' },
                sightseeing: { label: '觀光', color: '#4A90E2', icon: 'camera' },
                shopping: { label: '購物', color: '#FF69B4', icon: 'shopping-bag' },
                other: { label: '其他', color: '#95A5A6', icon: 'package' }
            };
            
            const categoryList = document.getElementById('categoryList');
            categoryList.innerHTML = Object.entries(categoryConfig).map(([key, config]) => {
                const spent = spending[key] || 0;
                const percentage = totalSpent > 0 ? (spent / totalSpent) * 100 : 0;
                
                return `
                    <div class="flex items-center space-x-4">
                        <div class="w-10 h-10 rounded-xl flex items-center justify-center" style="background-color: ${config.color}20">
                            <i data-lucide="${config.icon}" class="w-5 h-5" style="color: ${config.color}"></i>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center justify-between mb-1">
                                <span class="text-sm font-medium text-gray-700">${config.label}</span>
                                <span class="text-sm text-gray-500">¥${spent.toLocaleString()} (${percentage.toFixed(1)}%)</span>
                            </div>
                            <div class="h-2 bg-gray-100 rounded-full overflow-hidden">
                                <div class="h-full rounded-full" style="width: ${percentage}%; background-color: ${config.color}"></div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            // 圓餅圖
            const pieData = Object.entries(spending)
                .filter(([_, value]) => value > 0)
                .map(([key, value]) => ({
                    label: categoryConfig[key].label,
                    value,
                    color: categoryConfig[key].color
                }));
            
            if (budgetChart) {
                budgetChart.destroy();
            }
            
            const ctx = document.getElementById('budgetPieChart').getContext('2d');
            budgetChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: pieData.map(d => d.label),
                    datasets: [{
                        data: pieData.map(d => d.value),
                        backgroundColor: pieData.map(d => d.color),
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    cutout: '60%'
                }
            });
            
            lucide.createIcons();
        }
        
        function saveBudget() {
            const tripId = document.getElementById('budgetTripSelect').value;
            const trip = trips.find(t => t.id === tripId);
            
            if (trip) {
                trip.budget = {
                    ...trip.budget,
                    total: parseInt(document.getElementById('budgetInput').value) || 200000
                };
                saveData();
                updateBudgetDisplay();
                alert('預算已儲存');
            }
        }
        
        // 渲染檢查清單
        function renderChecklist() {
            const container = document.getElementById('checklistItems');
            const completedCount = checklist.filter(item => item.completed).length;
            const progress = checklist.length > 0 ? (completedCount / checklist.length) * 100 : 0;
            
            document.getElementById('checklistProgress').textContent = `${completedCount}/${checklist.length}`;
            document.getElementById('checklistProgressBar').style.width = `${progress}%`;
            
            container.innerHTML = checklist.map(item => `
                <button onclick="toggleChecklistItem('${item.id}')" class="w-full flex items-center space-x-3 p-3 rounded-xl transition-all ${item.completed ? 'bg-green-50' : 'bg-gray-50 hover:bg-gray-100'}">
                    <i data-lucide="${item.completed ? 'check-circle-2' : 'circle'}" class="w-5 h-5 flex-shrink-0 ${item.completed ? 'text-green-500' : 'text-gray-400'}"></i>
                    <span class="text-sm text-left flex-1 ${item.completed ? 'text-gray-400 line-through' : 'text-gray-700'}">${item.item}</span>
                </button>
            `).join('');
            
            lucide.createIcons();
        }
        
        function toggleChecklistItem(itemId) {
            checklist = checklist.map(item =>
                item.id === itemId ? { ...item, completed: !item.completed } : item
            );
            saveData();
            renderChecklist();
        }
        
        function addChecklistItem() {
            const input = document.getElementById('newChecklistItem');
            const value = input.value.trim();
            
            if (value) {
                checklist.push({
                    id: crypto.randomUUID(),
                    item: value,
                    completed: false
                });
                saveData();
                input.value = '';
                renderChecklist();
            }
        }
        
        // 貨幣轉換
        function convertJpyToHkd() {
            const jpy = parseFloat(document.getElementById('jpyAmount').value) || 0;
            const rate = parseFloat(document.getElementById('exchangeRate').value) || 0.051;
            document.getElementById('hkdAmount').value = (jpy * rate).toFixed(2);
        }
        
        function convertHkdToJpy() {
            const hkd = parseFloat(document.getElementById('hkdAmount').value) || 0;
            const rate = parseFloat(document.getElementById('exchangeRate').value) || 0.051;
            document.getElementById('jpyAmount').value = Math.round(hkd / rate);
        }
        
        function calculateCurrencyExpression() {
            const expr = document.getElementById('currencyExpression').value;
            try {
                const sanitized = expr.replace(/[^0-9+\-*/().]/g, '');
                const result = Function('"use strict"; return (' + sanitized + ')')();
                if (!isNaN(result)) {
                    document.getElementById('jpyAmount').value = result;
                    convertJpyToHkd();
                }
            } catch (e) {
                // 忽略錯誤
            }
        }
        
        // 折扣計算
        function calculateDiscount() {
            const price = parseFloat(document.getElementById('originalPrice').value) || 0;
            const discount = parseFloat(document.getElementById('discountInput').value) || 0;
            const discountRate = discount / 100;
            const finalPrice = Math.round(price * discountRate);
            const saved = price - finalPrice;
            
            document.getElementById('finalPrice').textContent = `¥${finalPrice.toLocaleString()}`;
            document.getElementById('savedAmount').textContent = `節省 ¥${saved.toLocaleString()}`;
            document.getElementById('discountLabel').textContent = `= ${discount}折 = ${100 - discount}% off`;
        }
        
        function updateDiscountInput() {
            document.getElementById('discountInput').value = document.getElementById('discountSlider').value;
        }
        
        function updateDiscountSlider() {
            document.getElementById('discountSlider').value = document.getElementById('discountInput').value;
        }
        
        function calculateDiscountExpression() {
            const expr = document.getElementById('discountExpression').value;
            try {
                const sanitized = expr.replace(/[^0-9+\-*/().]/g, '');
                const result = Function('"use strict"; return (' + sanitized + ')')();
                if (!isNaN(result)) {
                    document.getElementById('originalPrice').value = result;
                    calculateDiscount();
                }
            } catch (e) {
                // 忽略錯誤
            }
        }
        
        // 翻譯功能
        function translateText() {
            const sourceText = document.getElementById('sourceText').value.trim();
            if (!sourceText) return;
            
            // 模擬翻譯
            const mockTranslations = {
                'こんにちは': '你好',
                'ありがとう': '謝謝',
                'すみません': '不好意思',
                'いくらですか': '這個多少錢？',
                'トイレ': '廁所',
                '駅': '車站',
                '美味しい': '好吃',
                'お願いします': '拜託了'
            };
            
            const result = mockTranslations[sourceText] || `[翻譯結果] ${sourceText}`;
            
            document.getElementById('translatedText').textContent = result;
            document.getElementById('translationResult').classList.remove('hidden');
        }
        
        // 相機功能
        let cameraStream = null;
        
        function startCamera() {
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(stream => {
                    cameraStream = stream;
                    document.getElementById('cameraVideo').srcObject = stream;
                    document.getElementById('cameraPreview').classList.remove('hidden');
                    document.getElementById('cameraButtons').classList.add('hidden');
                    document.getElementById('imagePreview').classList.add('hidden');
                })
                .catch(err => {
                    alert('無法存取相機，請確認已授予權限');
                    console.error(err);
                });
        }
        
        function stopCamera() {
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            document.getElementById('cameraPreview').classList.add('hidden');
            document.getElementById('cameraButtons').classList.remove('hidden');
        }
        
        function captureImage() {
            const video = document.getElementById('cameraVideo');
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0);
            
            const imageData = canvas.toDataURL('image/jpeg');
            document.getElementById('uploadedImage').src = imageData;
            document.getElementById('imagePreview').classList.remove('hidden');
            
            stopCamera();
            
            // 模擬 OCR
            document.getElementById('sourceText').value = 'カメラで検出されたテキスト';
        }
        
        function handleImageUpload(e) {
            const file = e.target.files?.[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    document.getElementById('uploadedImage').src = reader.result;
                    document.getElementById('imagePreview').classList.remove('hidden');
                    document.getElementById('cameraButtons').classList.add('hidden');
                    document.getElementById('sourceText').value = '検出されたテキスト（偵測到的文字）';
                };
                reader.readAsDataURL(file);
            }
        }
        
        function clearImage() {
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('cameraButtons').classList.remove('hidden');
            document.getElementById('uploadedImage').src = '';
        }
        
        // 封面圖片上傳
        function handleCoverUpload(e) {
            const file = e.target.files?.[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    document.getElementById('coverImage').src = reader.result;
                    document.getElementById('coverPreview').classList.remove('hidden');
                    document.getElementById('coverUploadBtn').classList.add('hidden');
                };
                reader.readAsDataURL(file);
            }
            lucide.createIcons();
        }
        
        function clearCoverImage() {
            document.getElementById('coverImage').src = '';
            document.getElementById('coverPreview').classList.add('hidden');
            document.getElementById('coverUploadBtn').classList.remove('hidden');
            lucide.createIcons();
        }
        
        // 更新天數顯示
        function updateTripDays() {
            const startDate = document.getElementById('tripStartDate').value;
            const endDate = document.getElementById('tripEndDate').value;
            
            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;
                
                if (days > 0) {
                    document.getElementById('tripDaysCount').textContent = `共 ${days} 天`;
                    document.getElementById('tripDaysDisplay').classList.remove('hidden');
                } else {
                    document.getElementById('tripDaysDisplay').classList.add('hidden');
                }
            }
            lucide.createIcons();
        }
        
        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            renderTrips();
            lucide.createIcons();
        });
    </script>
</body>
</html>
